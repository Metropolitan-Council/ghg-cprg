---
title: EPA download guide
output:
    html_document: 
        keep_md: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  eval = TRUE,
  echo = FALSE,
  comment = "#>"
)

options(
  htmltools.dir.version = FALSE,
  crayon.enabled = TRUE
)

old.hooks <- fansi::set_knit_hooks(knitr::knit_hooks)

source(file.path(here::here(), "R/_load_pkgs.R"))

epa_downloads <- readxl::read_xlsx(file.path(here::here(), "_transportation/data-raw/epa/epa_downloads.xlsx")) %>%
  mutate(
    direct_link = map(direct_link, ~ htmltools::a(href = .x, .x)) %>%
      map(~ gt::html(as.character(.x)))
  )

epa_onroad_source_set <- readRDS(file.path(here::here(), "_transportation/data/epa_onroad_source_set.RDS"))
```


This document details how the _transportation/data-raw/epa/ folder is organized and lists the associated processing scripts for each dataset. 

Altogether, this folder comes to nearly 200 GB. If you plan to replicate these downloads on your machine, account for space accordingly.

All download links and essential description information is documented in [epa_downloads.xlsx](_transportation/data-raw/epa/epa_downloads.xlsx)

Keep in mind that URLs are relatively fragile and may change at any time. 

All datasets are processed from their unzipped locations in processing scripts. At the top of each script, there is a helper that looks for all the input datasets necessary. Ensure you have all the appropriate downloads unzipped and in the correct locations and run the scripts.

If you want to preview any of the CSVs, open them using your machine's text editor (TextEdit on Mac, Notepad on Windows). Do NOT open using Excel - it will crash. 

Copies of the intermediary datasets are available in our MS Team/OneDrive. 

Summary of direct inputs and outputs of all data in `epa_onroad_emissions_compile`

```{r}
epa_onroad_source_set %>%
  mutate(emissions_year = as.numeric(emissions_year)) %>%
  arrange(emissions_year) %>%
  gt() %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::cols_align(align = "left")
```


## Folder structure

Note that to save space, some unzipped data irrelevant to our region (like EPA regions outside of MN and WI, Texas, and California datasets) have been deleted. 

```{r, eval = FALSE}
# create folder structure
directories <- c(
  "nei/2008NEI", 
  "nei/2011NEI", 
  "nei/2014NEI",
  "nei/2017NEI", 
  "nei/2020NEI", 
  "nei/SmokeFlatFile_MN_WI",
  
  "air_emissions_modeling/2007",
  "air_emissions_modeling/2008", 
  "air_emissions_modeling/2011", 
  "air_emissions_modeling/2014", 
  "air_emissions_modeling/2015", 
  "air_emissions_modeling/2016", 
  "air_emissions_modeling/2017", 
  "air_emissions_modeling/2018", 
  "air_emissions_modeling/2019", 
  "air_emissions_modeling/2020", 
  "air_emissions_modeling/2021", 
  "air_emissions_modeling/2022v1", 
  "air_emissions_modeling/air_emissions_modeling_mn_wi",
  
  "air_emissions_modeling/EQUATES/CMAS_Data_Warehouse", 
  "air_emissions_modeling/EQUATES/EQUATES_2002", 
  "air_emissions_modeling/EQUATES/EQUATES_2005",
  "air_emissions_modeling/EQUATES/EQUATES_2008", 
  "air_emissions_modeling/EQUATES/EQUATES_2011",
  "air_emissions_modeling/EQUATES/EQUATES_2014", 
  "air_emissions_modeling/EQUATES/EQUATES_2017", 
  "air_emissions_modeling/EQUATES/EQUATES_MN_WI"
) %>% 
  purrr::map(
    fs::dir_create)

```


```{r}
fs::dir_tree(".",
             type = "directory",
             recurse = 0
)
```

### nei

The NEI is available from the EPA in multiple places at different aggregation levels

NEI should only be compared directly for years 2011 onward. Between 2008 and 2011, there were significant changes in the underlying source classification codes (SCCs).


```{r}
fs::dir_tree(
  "./nei",
  type = "directory",
  recurse = 0
)
```


Next, navigate to the links provided in the epa_downloads. These are data summaries broken out by on-road and non-road by EPA region. 

When prompted to download, save each download its the corresponding folder. 

NEI data are then compiled in a three locations 

- [epa_nei_onroad_emissions.R](../epa_nei_onroad_emissions.R)
- [epa_nei_nonroad_emissions.R](../epa_nei_nonroad_emissions.R)
- [epa_nei_smoke_ff.R](../epa_nei_smoke_ff.R)

NEI summary data are also fetched directly from the EnviroFacts API in [epa_nei_envirofacts.R](../epa_nei_envirofacts.R). 

On-road activity data and non-road emissions are not currently processed and saved. See GitHub for relevant Issues. 

```{r}
epa_downloads %>%
  filter(
    group == "NEI",
    measurement %in% c(
      "emissions",
      "smoke_flat_file"
    )
  ) %>%
  select(-file_name, -description) %>%
  arrange(category, measurement, inventory_year) %>%
  gt() %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::cols_align(align = "left")
```


### air_emissions_modeling

EPA teams continually work on air emissions modeling. These emissions modeling platforms support the development of emissions inputs for air quality modeling supporting efforts across government agencies. Platforms include everything from model-ready datasets for models like CMAQ, MOVES, and SMOKE, scripts, output datasets, shapefiles, tables, and documentation. 

The organizing body for air emissions modeling is [Community Modeling and Analysis System (CMAS)](https://www.cmascenter.org/). CMAS offers a [discussion forum](https://forum.cmascenter.org/) for folks to collaborate and ask questions. Staff scientists from the EPA, air quality monitoring agencies, and other organizations answer questions and respond to bug reports. 

County-level data are only available at the continental US (CONUS) level; these datasets include all counties in the US and are very large. 

The data available for each platform year varies. Data is much more consistently available and standardized from 2014 onward. 

When you unzip each downloaded file, move all contents of each inputs/ directory into a single group.
For example, when you unzip 2022hc_onroad_SMOKE-MOVES_MOVES4_emissions_FF10_23dec2024.zip, it unzips into a new diretory, 2022hc_cb6_22m/. 
Later, when you unzip 2022hc_nonroad_inventory_20dec2024.zip, it will also create a 2022hc_cb6_22m/ directory, and your machine will append the directory name with a number (i.e. "2022hc_cb6_22m 2").
Once you have unzipped all the downloads, move all the contents of each 2022hc_cb6_22m (2,3,etc)/inputs/ into the first 2022hc_cb6_22m/inputs/ folder.

Air emissions modeling data are compiled in two locations 

- [epa_air_emissions_modeling_onroad.R](../epa_air_emissions_modeling_onroad.R)
- [epa_air_emissions_modeling_nonroad.R](../epa_air_emissions_modeling_nonroad.R)


```{r}
fs::dir_tree("./air_emissions_modeling/",
             type = "directory",
             recurse = 0
)
```


```{r}
epa_downloads %>%
  filter(
    group == "emismod",
    measurement == "emissions",
    inventory_year >= 2011
  ) %>%
  select(-file_name, -description) %>%
  arrange(category, inventory_year) %>%
  gt() %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::cols_align(align = "left")
```


#### EQUATES

EQUATES data is located on the EPA FTP site *and* the CMAS Data Warehouse Google Drive. Direct links are provided for both locations. 

EQUATES only has on-road data from 2002 to 2019. 

Download the data for each of the given links and save in the appropriate location. If the direct Google Drive links are not working for you, download each one from the [directory page](https://drive.google.com/drive/folders/1bOb-xVqNu5uAY-wKXqTuV70qwqKkfpNz). 

All EQUATES data is processed in [epa_equates_read.R](./../epa_equates_read.R)

```{r}
fs::dir_tree("./air_emissions_modeling/EQUATES/",
             type = "directory",
             recurse = 0
)
```

```{r}
epa_downloads %>%
  filter(
    group == "EQUATES",
    measurement %in% c(
      "emissions",
      "smoke_flat_file"
    )
  ) %>%
  select(-file_name, -description) %>%
  arrange(category, inventory_year) %>%
  gt() %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::cols_align(align = "left")
```
