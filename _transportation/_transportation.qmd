# Mobile combustion  
```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
hookaddcap()
```
## Introduction

Transportation is consistently the highest source of emissions in the state (MPCA report). 

## Methods

The general workflow for transportation emissions is to find vehicle miles traveled for a given geography, 

$$Emmissions = miles \times \frac{\text{GHG grams}}{mile}$$

### Vehicle Miles Traveled      

To find the estimate number of vehicle miles traveled (VMT), we used the estimated number of vehicles and the average trip length in miles for all origin - destination pairs. VMT is calculated as follows:

$$VMT{_v} = trips{_v} \times length{_v}$$

where 

$$trips = \text{number of trips}$$
$$length = \text{average trip length in miles}$$
$$v = \text{vehicle type}$$

### Emissions factors

$$Emissions=\frac{1}{2}T_{o} + \frac{1}{2}T_{d}  + T{_d}$$

where

$$T_o=\textrm{grams of emissions for each GHG from all trips originating in the county}$$

$$T_d=\textrm{grams of emissions for each GHG from all trips ending in the county}$$ 

## Results

```{r fig-transportation-county-emissions}
#| fig-cap: "2021 annual emissions by vehicle weight"
#| out-width: "95%"
vmt_emissions <- readRDS(file.path(here::here(), "_transportation/data/county_vmt_emissions.RDS"))

vmt_emissions_all <- vmt_emissions %>%
  group_by(zone) %>%
  summarise(
    vmt_total = sum(vmt_total),
    vmt_same = sum(vmt_same),
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  )

plot_ly(
  type = "bar",
  source = opts_current$get()$label,
  data = vmt_emissions,
  y = ~ reorder(zone, emissions_metric_tons_co2e),
  x = ~emissions_metric_tons_co2e,
  color = ~vehicle_weight_label,
  hovertemplate = ~ paste0(
    zone, " County", "<br>",
    vehicle_weight_label, "<br>",
    round(emissions_metric_tons_co2e * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  plotly_layout(
    main_title = "2021 annual emissions by vehicle weight",
    subtitle = "",
    y_title = "County",
    x_title = "Greenhouse gases emitted (metric tons)",
    legend_title = "Vehicle weight"
  ) %>%
  layout(
    barmode = "stack",
    legend = list(
      traceorder = "reversed"
    )
  )
```


### Correlation with related data

We would expect counties with higher population to have higher emissions and VMT.

```{r fig-emissions-population}
#| fig-cap: "County population and emissions"
#| out-width: "95%"
cprg_population <- readRDS(file.path(here::here(), "_meta/data/cprg_population.RDS"))
vmt_population <- left_join(vmt_emissions_all, cprg_population,
  by = c("zone" = "NAME")
)
plot_ly(
  data = vmt_population,
  source = opts_current$get()$label,
  x = ~population,
  y = ~emissions_metric_tons_co2e,
  type = "scatter",
  mode = "markers",
  hovertemplate = ~ paste0(
    zone, " County", "<br>",
    "Population: ", scales::comma(population), "<br>",
    "Emissions: ", round(emissions_metric_tons_co2e * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  ),
  opacity = 0.7,
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "County population and emissions",
    subtitle = "2021 ACS 5-year population estimates. Strong positive correlation",
    x_title = "Total population",
    y_title = "Emissions",
    legend_title = "",
    legend = list(orientation = "h")
  )
```


To validate our county origin-destination VMT data, we can compare the county totals to the DOT reported values from MnDOT [@mndotVMTRouteSystem2021] and WisDOT [@wisdotWisconsinVehicleMiles2021]. Note that these data include all vehicles, passenger and commercial. 

```{r hpms-vmt}
dot_vmt <- readRDS(file.path(here::here(), "_transportation/data/dot_vmt.RDS")) %>%
  filter(year == 2021)

dot_streetlight <- left_join(
  vmt_emissions_all,
  dot_vmt,
  by = c("zone" = "county")
) %>%
  unique()
```


```{r fig-streetlight-hpms}
#| fig-cap: "County vehicle miles traveled and StreetLight Volume"
#| out-width: "95%"
plot_ly(
  data = dot_streetlight,
  source = opts_current$get()$label,
  x = ~annual_vmt,
  y = ~vmt_total,
  type = "scatter",
  mode = "markers",
  hovertemplate = ~ paste0(
    "County: ", zone, "<br>",
    "Annual VMT: ", round(annual_vmt * 1e-9, digits = 2), " billion<br>",
    "StreetLight VMT: ", round(vmt_total * 1e-9, digits = 2), " billion<br>",
    "<extra></extra>"
  ),
  opacity = 0.7,
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "County vehicle miles traveled and StreetLight Volume",
    subtitle = "Strong positive correlation",
    x_title = "Annual VMT (HPMS)",
    y_title = "StreetLight VMT",
    legend_title = "",
    legend = list(orientation = "h")
  )
```

### Comparison with other inventories

- StreetLight GHG inventory method, if released in time.
- 2018 Met Council inventory
- LGGIT

#### National Emissions Inventory 

The National Emissions Inventory (NEI) is a comprehensive and detailed estimate of air emissions of criteria pollutants, criteria precursors, and hazardous air pollutants from air emissions sources. The county-level GHG emissions included in the NEI for this category are calculated by running the MOVES model with State-, Local-, and Tribal-submitted activity data and EPA-developed activity inputs based on data from FHWA and other sources [@usepa2020NationalEmissions2023]. 

```{r read-nei}
epa_nei <- readRDS(file.path(here::here(), "_transportation/data/epa_nei.RDS"))

nei_emissions_all <- epa_nei %>%
  group_by(zone = county_name) %>%
  summarize(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  )
```

We expect that the NEI data will show higher emissions, because it is based on overall activity, not explicit origin-destination travel. 

```{r fig-activity-vs-nei}
#| fig-cap: "County estimated emissions, NEI and calculated "
#| out-width: "95%"
plot_ly(
  data = vmt_emissions_all,
  source = opts_current$get()$label,
  x = ~ reorder(zone, -emissions_metric_tons_co2e),
  y = ~emissions_metric_tons_co2e,
  type = "scatter",
  mode = "markers",
  name = "2021 activity/origin-destination",
  hovertemplate = ~ paste0(
    zone, " County<br>",
    "Emissions: ", round(emissions_metric_tons_co2e * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  ),
  opacity = 0.8,
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  add_trace(
    data = nei_emissions_all,
    name = "2020 NEI on-road emissions",
    hovertemplate = ~ paste0(
      zone, " County<br>",
      "NEI Emissions: ", round(emissions_metric_tons_co2e * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
      "<extra></extra>"
    )
  ) %>%
  plotly_layout(
    main_title = "County estimated vehicle emissions",
    subtitle = "2020 NEI, all on-road emissions",
    x_title = "County",
    y_title = "Greenhouse gases emitted (metric tons)",
    legend_title = "Emissions data source"
  )
```

#### Local Greenhouse Gas Inventory Tool (LGGIT)

EPAâ€™s Local Greenhouse Gas Inventory Tool (LGGIT) was developed to help communities across the United States to evaluate their greenhouse gas emissions. We used the LGGIT to validate our calculations and datasets.

We used the LGGIT Excel workbook tool with the following inputs in the "Mobile-Data" sheet. Several calculations were made

- Passenger VMT was split between gasoline and diesel powered vehicles based on regional fleet composition in the TBI.
- Passenger vehicle age was determined from the median vehicle model year in the TBI. 
- Fuel consumption was calculated by dividing VMT by average vehicle miles per gallon (MPG), specific to vehicle type and fuel type. Fuel efficiency data were taken from the LGGIT tool. 

All medium-duty VMT were classified as "Light Truck", while all heavy-duty VMT were classified as "Heavy-Duty Vehicle".

Additionally, commercial trucks were assumed to be year 2007, based on a 2018 report that found the average age of trucks in the US to be 14.2 years [@brusseauAgingTrucksCreate2019] (`2021 - 14 = 2007`). 


```{r tbl-lggit-entries}
#| tbl-cap: "Mobile data entered into LGGIT"
#| out-width: "95%"
lggit_vmt_entries <- readRDS(file.path(here::here(), "_transportation/data-raw/epa/lggit_vmt_entries.RDS"))

(lggit_vmt_entries) %>%
  gt() %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::as_raw_html()
```


```{r lggit-calculations}
cprg_total_emiss <- vmt_emissions_all %>%
  ungroup() %>%
  summarise(emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)) %>%
  magrittr::extract2("emissions_metric_tons_co2e") %>%
  scales::comma()

lggit_totals <- readRDS(file.path(here::here(), "_transportation/data-raw/epa/lggit_totals.RDS"))

lggit_total_emiss <- (lggit_totals$total %>% sum()) %>% scales::comma()
```

The results from the LGGIT tool indicate a regional total of `r lggit_total_emiss` metric tons CO~2~e, while our calculations indicate `r cprg_total_emiss` metric tons CO~2~e. These values are sufficiently close, and may be explained by differences between nationwide vehicle emission rates and fuel efficiency and region-specific values from EPA MOVES. See @sec-epa-moves for a more detailed comparison.

```{r echo=FALSE}
saveCap("trans")
```
