## EPA MOVES {#sec-epa-moves}
```{r}
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_quarto_helpers.R"))
epa_moves <- readRDS(file.path(here::here(), "_transportation/data/epa_moves.RDS"))
epa_moves_meta <- readRDS(file.path(here::here(), "_transportation/data/epa_moves_meta.RDS"))
hookaddcap()
```

Emissions rates for our region were calculated using the EPA's [Motor Vehicle Emissions Simulator (MOVES4)](https://www.epa.gov/moves) [@usepaMotorVehicleEmission2023]. MOVES4 calculates emissions factors using Council's regional travel demand model, Minnesota Department of Vehicle Services county vehicle registration data, and the Minnesota Pollution Control Agency vehicle age distribution. Each of these inputs helps the model estimate the characteristics of vehicles on the road in our region. The model takes into account differences in fuel economy (miles per gallon) depending on a vehicle's age and size, as well as its fuel intake (diesel or gasoline). The results are specific to the conditions of our region, and so are more accurate than national averages. 

MOVES is a high-quality government modeling system with strong data inputs and outputs.  

CO~2~ equivalence (CO~2~e) values are derived using global warming potential (GWP) values. See @sec-gwp for more details.
```{r clean-emiss-rates}
epa_moves_clean <- epa_moves %>%
  rowwise() %>%
  mutate(
    `Kilograms CH4 per mile` = ch4 / 1000,
    `Kilograms N2O per mile` = n2o / 1000,
    `Kilograms CO2 per mile` = co2 / 1000,
    `Kilograms CO2e per mile` = co2_co2_equivalent / 1000
  ) %>%
  mutate(
    `Grams CH₄ per mile` = `Kilograms CH4 per mile` * 1000,
    `Grams N₂O per mile` = `Kilograms N2O per mile` * 1000,
    `Grams CO₂ per mile` = `Kilograms CO2 per mile` * 1000,
    `Grams CO₂e per mile` = `Kilograms CO2e per mile` * 1000
  ) %>%
  select(
    `Vehicle weight` = vehicle_weight,
    `MOVES year` = moves_year,
    starts_with("grams")
  ) 

lggit_kg_emissions_per_mile <- readRDS(file.path(here::here(), "_transportation/data-raw/epa/lggit_kg_emissions_per_mile.RDS"))

lggit_clean <- lggit_kg_emissions_per_mile %>%
  select(
    `Vehicle type` = `Vehicle Type`,
    `Vehicle model year` = `Vehicle Year`,
    `Fuel type` = `Fuel Type`,
    `Average miles per gallon`,
    `Kilograms CH4 per mile`,
    `Kilograms N2O per mile`,
    `Kilograms CO2 per mile`,
    `Kilograms CO2e per mile`
  ) %>%
  mutate(
    `Grams CH₄ per mile` = `Kilograms CH4 per mile` * 1000,
    `Grams N₂O per mile` = `Kilograms N2O per mile` * 1000,
    `Grams CO₂ per mile` = `Kilograms CO2 per mile` * 1000,
    `Grams CO₂e per mile` = `Kilograms CO2e per mile` * 1000
  ) %>%
  select(
    `Vehicle type`,
    `Vehicle model year`,
    `Fuel type`,
    starts_with("grams")
  ) 
```


```{r tbl-epa-moves-values}
#| tbl-cap: "Emissions in grams per vehicle mile traveled by vehicle weight in the Twin Cities region. EPA MOVES4"
#| out-width: "95%"
epa_moves_clean %>% 
  gt() %>%
  gt::opt_row_striping() %>%
  fmt_number(3:6, decimals = 2) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::as_raw_html()
```

For comparison, we pulled the emissions per mile rates from the Local Greenhouse Gas Inventory Tool (LGGIT), which align with the 2021 EPA GHG Emission Hub [@usepaGHGEmissionFactors2021]. 

```{r tbl-lggit-emissions-per-mile}
#| tbl-cap: "Grams of emissions per mile by vehicle type and fuel type. EPA GHG Emission Hub (2021)"
#| out-width: "95%"
lggit_clean %>%
  gt() %>%
  fmt_number(4:7, decimals = 2) %>%
  gt::opt_row_striping() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  gt::as_raw_html()
```


```{r}
epa_plus_moves <- bind_rows(epa_moves_clean %>% 
            mutate(data_source = "MOVES"),
          lggit_clean %>% 
            mutate(data_source = "EPA GHG Hub",
                   `Vehicle weight` = case_when(`Vehicle type` == "Passenger Car" ~ "Passenger",
                                                `Vehicle type` == "Light Truck" ~ "Medium",
                                                `Vehicle type` == "Heavy-Duty Vehicle" ~ "Heavy"))) %>% 
  select(-`Grams CH₄ per mile`, -`Grams N₂O per mile`,
         -`Grams CO₂ per mile`) %>% 
  pivot_longer(cols = 3, 
               names_to = "ghg_factor")

plot_ly(
  data = epa_plus_moves,
  x = ~`Vehicle weight`,
  y = ~value,
  color = ~data_source,
  type = "bar"
) %>% 
  plotly_layout() %>% 
  layout(barmode = "identity")
```



Data source description, type

- What is the raw unit of measurement? 
- How was this data accessed? Include any relevant links/citations, code, or downloads.
- What data cleaning or wrangling was completed? How did you test these processes and outputs?
- What is the geographic and temporal scope? Did you complete any aggregation?
- What version is the data? Were there other versions available? If so, why did you choose this version?
- What assumptions are made when we use this dataset?
- Which subject matter expert (SME) reviewed this data?
- Describe testing used to verify data

### Limitations

- This edition of MOVES is fairly old relative to our estimation year (2021).
- We are not breaking out vehicles by fuel type; instead, we are aggregating based on the regional fleet. This may result in more inaccuracies.
- This only accounts for vehicles that are registered in the 7-county metro area, so may not be precisely representative of vehicles on our roads, but registered elsewhere. 
- 


<!-- ### Data dictionary -->

<!-- ```{r tbl-epa-moves-meta} -->
<!-- #| tbl-cap: "EPA MOVES metadata" -->
<!-- #| out-width: "95%" -->
<!-- epa_moves_meta %>% -->
<!--   gt() %>% -->
<!--   gt::opt_row_striping() %>% -->
<!--   tab_style( -->
<!--     style = cell_text(weight = "bold"), -->
<!--     locations = cells_column_labels() -->
<!--   ) %>% -->
<!--   gt::fmt_markdown() %>% -->
<!--   gt::as_raw_html() -->
<!-- ``` -->



```{r echo=FALSE}
caption_index <- readRDS(file.path(here::here(), "caption_index.RDS"))
caption_index <- as.character(as.numeric(caption_index) + 1) %>% stringr::str_pad(width = 2, side = "left", pad = "0")
saveCap(paste0("cap-", caption_index))
saveRDS(caption_index, file.path(here::here(), "caption_index.RDS"))
```
