## StreetLight Data
```{r}
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_quarto_helpers.R"))
cprg_county <- readRDS("../R/data/cprg_county.RDS")
hookaddcap()
```

[StreetLight Data](https://www.streetlightdata.com/) is a transportation analytics platform that uses aggregated location-based services (LBS) data from cell phones and navigation/GPS data to deliver insights on travel patterns. For this project, we used StreetLight to find the volume of traffic going from each county and city or township unit (CTU) to each CTU for personal and commercial traffic during 2021.

For ease of access, we used `{streetlightR}`, an R package, to interact directly with the StreetLight API. `{streetlightR}` is open-source and maintained by Council staff [^ Maintainer: Liz Roten]. 

Data source description, type

- StreetLight Data, falls in second rank. Quality rank (See @tbl-quality-rank)
- How, when, and why was the data collected?
- If this is a modeled dataset, what is the sample?
- What is the raw unit of measurement? 
- How was this data accessed? Include any relevant links/citations, code, or downloads.
- What data cleaning or wrangling was completed? How did you test these processes and outputs?
- What is the geographic and temporal scope? Did you complete any aggregation?
- What version is the data? Were there other versions available? If so, why did you choose this version?
- What assumptions are made when we use this dataset?
- Which subject matter expert (SME) reviewed this data?
- Describe testing used to verify data

Be sure to add a citation of this dataset to the Zotero shared library.

### Data characteristics

- Were there any missing data? How did you handle missing data?
- Plots, tables, and description of data distribution
- Variance, Z-Score, quantiles
- Facet views by categorical variables

### Passenger 

#### Trip length validation 

To test logical validity of trip lengths, we will compare the minimum distance between each origin and destination with the average trip length. These should correlate.

```{r calc-min-county-dist}
# create distance matrix
county_distance_matrix <- sf::st_distance(
  cprg_county,
  cprg_county
)

# unpack distance matrix
cprg_distances <- purrr::map_dfr(
  1:nrow(cprg_county),
  function(x) {
    tibble(
      origin_zone_name = cprg_county$NAME[x],
      destination_zone_name = cprg_county$NAME,
      distance_miles = units::set_units(
        county_distance_matrix[x, ],
        "miles"
      ) %>% as.numeric()
    )
  }
)
```

```{r stl-pass-county-run}
# read in county passenger 2021 StL run
county21_data <- readRDS("data-raw/analysis_runs/county21_data.RDS")

passenger_od <- county21_data$od_all %>%
  filter(
    day_type == "0: All Days (M-Su)",
    day_part == "0: All Day (12am-12am)"
  ) %>%
  select(
    analysis_name, metric_group,
    mode_of_travel, origin_zone_name,
    destination_zone_name, day_type, day_part,
    average_daily_o_d_traffic_st_l_volume
  )

passenger_od_trip <- county21_data$od_trip_all %>%
  filter(
    day_type == "0: All Days (M-Su)",
    day_part == "0: All Day (12am-12am)"
  ) %>%
  select(
    analysis_name,
    origin_zone_name,
    destination_zone_name,
    day_type, day_part, avg_trip_length_mi,
    avg_all_trip_length_mi
  )

# combine with county distance data
passenger_od_distance <- passenger_od_trip %>%
  left_join(cprg_distances, join_by(origin_zone_name, destination_zone_name)) %>%
  rowwise() %>%
  # create tooltip text
  mutate(hovertext = paste0(
    "Origin county: ", origin_zone_name, "<br>",
    "Destination county: ", destination_zone_name, "<br>",
    "Minimum distance: ", round(distance_miles), " miles", "<br>",
    "Average trip length: ", round(avg_all_trip_length_mi, digits = 2), " miles",
    "<extra></extra>"
  )) %>%
  mutate(
    pair_type = case_when(
      distance_miles == 0 ~ "Adjacent or same county",
      origin_zone_name == destination_zone_name ~ "Adjacent or same county",
      TRUE ~ "Non-adjacent counties"
    )
  )
```


In cases where the origin and destination counties are not adjacent, the average trip length is consistently higher than the minimum distance between the counties. 

```{r fig-trip-dist-min-dist}
#| fig-cap: "Avg. trip distance and minimum distance between counties"
one_slope <- tibble(
  x = 0:max(passenger_od_distance$distance_miles + 10),
  y = 0:max(passenger_od_distance$distance_miles + 10),
  hovertext = "1-1 slope <extra></extra>"
)

plot_ly(
  data = passenger_od_distance,
  x = ~distance_miles,
  y = ~avg_all_trip_length_mi,
  color = ~pair_type,
  type = "scatter",
  mode = "markers",
  hoverinfo = "text",
  hovertemplate = passenger_od_distance$hovertext,
  opacity = 0.7,
  colors = c(
    colors$councilBlue,
    colors$metrostatsDaPurp
  ),
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  add_trace(
    inherit = FALSE,
    name = "1-1 correlation",
    data = one_slope,
    type = "scatter",
    mode = "lines",
    x = ~x,
    y = ~y,
    hoverinfo = "text",
    hovertemplate = one_slope$hovertext,
    line = list(color = "gray")
  ) %>%
  plotly_layout(
    main_title = "Avg. trip distance and minimum distance between counties",
    subtitle = "Adjacent or within counties have a minimum distance of 0 miles",
    x_title = "Minimum distance between counties (miles)",
    y_title = "Average trip distance (miles)",
    legend_title = "",
    legend = list(orientation = "h")
  )
```


We would also expect that large counties will have longer trip lengths and smaller counties will have shorter trip lengths. 

Comparing trip distance and county area, we see a general positive correlation (the larger the county, the longer the average trip). 

```{r fig-trip-county-area}
#| fig-cap: "Avg. distance for trips within county and county area"
cprg_area <- cprg_county %>%
  mutate(area_sq_mi = sf::st_area(cprg_county) %>% units::set_units("mi^2") %>%
           as.numeric())

passenger_dist_area <- left_join(
  passenger_od_trip %>%
    filter(origin_zone_name == destination_zone_name),
  cprg_area,
  by = c("origin_zone_name" = "NAME")
) %>%
  mutate(hovertext = paste0(
    "County: ", origin_zone_name, "<br>",
    "County area: ", round(area_sq_mi), " sq. miles", "<br>",
    "Average trip length: ", round(avg_all_trip_length_mi, digits = 2), " miles",
    "<extra></extra>"
  ))


plot_ly(
  data = passenger_dist_area,
  x = ~area_sq_mi,
  y = ~avg_all_trip_length_mi,
  type = "scatter",
  mode = "markers",
  hoverinfo = "text",
  hovertemplate = passenger_dist_area$hovertext,
  opacity = 0.7,
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "Avg. trip distance within county and county area",
    subtitle = "General positive correlation",
    x_title = "County area (square miles)",
    y_title = "Average trip distance (miles)",
    legend_title = "",
    legend = list(orientation = "h")
  )
```


#### Comparison with HPMS VMT data

To validate our county origin-destination VMT data, we can compare the county totals to the DOT reported values from MnDOT [@mndotVMTRouteSystem2021] and WisDOT [@wisdotWisconsinVehicleMiles2021]. Note that these data include all vehicles, passenger and commercial. 

```{r hpms-vmt}
mndot_vmt <- readRDS("data-raw/mndot/mndot_vmt_county.RDS") %>%
  mutate(data_source = "MnDOT")
wisdot_vmt <- readRDS("data-raw/wisdot/wisdot_vmt_county.RDS") %>%
  mutate(data_source = "WisDOT")

hpms_vmt <- bind_rows(
  mndot_vmt,
  wisdot_vmt
)
```

<!-- scatter plot comparing 2021 HPMS vmt with StL VMT -->

### Freight 

StreetLight does not provide StreetLight Volume for 2021 commercial vehicle analyses. To measure volume for commercial traffic, we used the StreetLight Index, a relative measure of traffic volume [@streetlightdataStreetLightIndex2023, calibrated using AADT values to result in traffic volume. 

StreetLight compares the AADT calibration values for a given zone with StreetLightâ€™s sample size for the same zone, and creates a calibration factor to apply to the entire analysis [@streetlightdataWhatSingleFactor2023]. We generated a calibration zone set for commercial traffic by selecting road segments with both AADT and vehicle classification data in both MN and WI.

State DOT's operates vehicle classification stations across the state, which provide both the volume of traffic on a given road segment and the breakdown of volume by vehicle type. We obtained this breakdown using data from MnDOT [@mndotYearlyVolumeTrends2021] and WisDOT [@wisdotWisconsinVehicleClassification2020]. 

<!-- Add table comparing vehicle classification definitions -->

Then, we selected only the stations within the study area with observations in the last five years (2017-2021). Finally, we joined this data with Average Annual Daily Traffic (AADT) [@mndotVMTRouteSystem2021, @wisdotWisconsinVehicleMiles2021] road segments by station ID. The road segments sampled include multiple road functional classes and segments in all seven metro counties. All traffic sensor stations pulled were permanent, continuous monitoring sites.

<!-- map of calibration points and lines -->
```{r}
freight_lines <- bind_rows(readRDS(file.path(here::here(), "_transportation/data-raw/mndot/mn_stations_ratios.RDS")) %>% 
                             mutate(name = paste0("MN_", sequence_n, "_", continuous_number),
                                    year = as.numeric(year)) %>% 
                             select(name, year, passenger, medium_duty, heavy_duty,  current_volume, geometry= geom),
                           readRDS(file.path(here::here(), "_transportation/data-raw/wisdot/wi_stations_ratios.RDS")) %>% 
                             mutate(name = paste0("WI_", site_id )) %>% 
                             select(name, year, passenger, medium_duty, heavy_duty,  current_volume, geometry))

freight_points <- bind_rows()

```

<!-- plot of passenger/medium/heavy percentages for each calibration zone -->

#### Calibration 

For calibration, we found the ratio of passenger/medium/heavy-duty vehicles for traffic sensors within our study areas. 

MnDOT provides AADT road segments, which align with station identification numbers. Wisconsin does not readily supply road segment data - as suggested by the Wisconsin cartographers office [@statecartographersofficeWisconsinRoadData21], we pulled OpenStreetMaps road data. 

To maximize data availability, we used the most recent data available, up to 2021 for both states. 

### Limitations

### Comparison with similar datasets


### Data dictionary

Table with detailed description of columns and definitions for each data table.

```{r echo=FALSE}
saveCap("stl-data")
```
