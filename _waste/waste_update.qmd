```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))
cprg_population <- readRDS(file.path(here::here(), "_meta/data/cprg_population.RDS"))
epa_waste_inventory <- readRDS(file.path(here::here(), "_waste/data-raw/epa_solidwaste_inventory.RDS"))

federal_totals <- epa_waste_inventory %>%
  filter(source == "Total") %>%
  select(
    geog_name,
    source,
    emissions_metric_tons_co2e,
    data_source
  )

cprg_ctu <- readRDS(file.path(here::here(), "_meta/data/cprg_ctu.RDS"))
sw_emissions <- readRDS(file.path(here::here(), "_waste/data/solid_waste_MN_allyrs.RDS"))
county_emissions_old <- readRDS(file.path(here::here(), "_meta/data/cprg_county_emissions.RDS"))
hookaddcap()
```

This is an in-progress document to work on documentation and data exploration for the update of the inventory without interfering with previous documentation.

## Methods

Solid waste emissions for Minnesota and Wisconsin are calculated using two different methods due to a difference in data availability. 

### Minnesota

The previous iteration of this inventory calculated Minnesota's solid waste emissions by multiplying activity totals by emissions factors from the EPA's Emissions Factor Hub. This update instead uses methodologies recommended by the Intergovernmental Panel on Climate Change (IPCC) (cite).The methodologies were selected to align with best practices for community-wide inventories using the IPCC recommendations and the guidance of the Global Protocol for Community-Scale Greenhouse Gas Inventories (cite).

#### Landfill

The IPCC suggests two alternatives for calculating landfill emissions, a first order decay model and a methane commitment model. The first order decay model is often used for larger-scale inventories, such as the US Federal Inventory, and requires waste data going back to 1950. Given the data available and the scope of this inventory, we chose to instead use the simpler methane commitment model to calculate county-level emissions for Minnesota.

The methane commitment model calculates methane emissions from landfills for a given year by multiplying municipal solid waste totals by a methane generation potential and adjusting for oxidation and methane flaring,

$$Emissions_{CH_4} = [(MSW \times L_0 )-rec] \times (1 – ox) $$

$MSW$, or the amount of municipal solid waste processed in landfills, is reported on a county level by MPCA's SCORE report (@sec-mpca-score).
<!-- make sure the above link refers to the most current information! -->
It is then multiplied by a methane generation potential $L_0$. In some processes, the amount of methane recovered from landfills, either through methane flaring or landfill gas to energy programs, is subtracted here. Due to data concerns and best practices recommendations, we have chosen not to include methane recovery in our Minnesota emissions calculations. Learn more in @sec-epa-methane. 

After subtracting methane recovered, emissions are multiplied by $1-ox$ to account for oxidation in the landfill. Our oxidation value is assigned the IPCC default of 0.1.

$L_0$, the methane generation potential, is calculated as follows:

$$L_0 = MCF × DOC_f × F × 16/12 \times DOC$$ where

-   $MCF$ = methane commitment factor. Assigned IPCC default of 0.5 for managed, semi-aerobic landfills.
-   $DOC_f$ = fraction of degradable organic carbon degraded. Assigned IPCC default of 0.6.
-   $F$ = fraction of methane in landfill gas. Assigned IPCC default of 0.5.
-   $16/12$ = ??
-   $DOC$ = degradable organic carbon. Calculated based on local waste makeup data from MPCA's [2013 Statewide Waste Characterization study](https://www.pca.state.mn.us/sites/default/files/w-sw1-60.pdf), using the equation $DOC = ( 0.4 \times \text{paper/textiles}) + ( 0.17 \times \text{non-food organics}) + ( 0.15 \times \text{food waste}) + ( 0.3 \times \text{wood/straw})$.

#### Compost

Compost produces both methane and nitrous oxide. Emissions are calculated by multiplying waste activity totals by emissions factors divided between aerobic and anaerobic digesters. Since Minnesota only has one anaerobic digester, we assumed 0% anaerobic digestion in the inventory area (source).

$$Emissions_{CH_4} = MSW_{compost} \times 10 \times 10^{-3}$$

$$Emissions_{N_2O} = MSW_{compost} \times 0.6 \times 10^{-3}$$

As in other sections, MSW activity data comes from MPCA's SCORE report. The emissions factors of 10 and 0.6 come from IPCC default values.

#### Incineration

Since incineration data is reported to SCORE as Waste to Energy, it is assumed that all incineration in the MSA is considered Waste to Energy.

Incineration of waste produces CH~4~, CO~2~, and N~2~O emissions. However, the Global Protocol for Community-Scale Greenhouse Gas Emission Inventories reports negligible CH~4~ emissions for continuous incineration facilities. 
<!-- \[CHECK IF WE USE STOKERS OR FLUIDIZED BEDS - STOKER EF \~0.2\] -->

$$Emissions_{CO_2} = (MSW_{incinerated} \times E_i + MSW_{onsite} \times E_o) \times FCC
\times FFC \times 44/12$$

$$Emissions_{N_2O} = MSW_{incinerated} \times EF_{N_2O} \times 10^{-6}$$

where:

-   $MSW_{incinerated}$ = municipal solid waste incinerated, as reported by SCORE.

-   $E_i$ = efficiency of combustion for incineration. Assigned IPCC default of 95%.

-   $MSW_{onsite}$ = municipal solid waste burned onsite, as reported by SCORE.

-   $E_o$ = efficiency of combustion for onsite burning. Assigned Greenhouse Gas Protocol default of 71%.

-   $FCC$ = fraction of carbon content in MSW. Assigned IPCC default of 40%.

-   $FFC$ = fraction of fossil carbon in MSW. Assigned IPCC default of 40%.

-   $EF_{N_2O}$ = aggregate N~2~O emission factor for MSW. Assigned GHG Protocol default of 50 g N~2~O/ metric tons waste for continuous and semi-continuous incinerators.

#### Limitations

Because the methane commitment method for landfill emissions calculates emissions slightly differently than the IPCC-encouraged First Order Decay model, landfill results may differ slightly from sources that use First Order Decay, such as the EPA's National Inventory and its State Inventory Tools. Both methods are accepted as valid ways to estimate solid waste emissions.

MPCA SCORE does not report activity data for waste generated and processed by industry. 
<!-- [check SIT tool - what % does EPA assign industry?] -->

Emissions are not calculated for waste that is recycled, as any emissions generated in the recycling process come from the energy use of the facilities or transportation and are accounted for in other sectors of this inventory.

### Wisconsin

Wisconsin emissions are calculated by interpolating and scaling down state-level data from the Wisconsin DNR [@wisconsindnrGreenhouseGas2021].

This 2021 inventory estimates landfill and waste-to-energy emissions for the years 2005 and 2018, including methane recovery offsets. In order to fill in missing years, emissions between 2005 and 2018 were linearly interpolated. Due to the small amount of change in emissions, it was assumed that emissions from 2018 to 2021 were constant. These emissions were then allocated to counties based on population.

## Data Sources

{{< include data_mpca_score_2021.qmd >}}

### MPCA Waste Characterization Study

In 2013, the MPCA contracted with Burns & McDonnell Engineering Company, Inc. to conduct a waste characterization study of landfill waste, an update to an earlier study in the year 2000. For simplicity, we have chosen to set waste proportions equal to those 2013 values for all years in this inventory.

The study sampled waste makeup from six waste disposal facilities across the state and used the results to model statewide totals. More details can be found in study documentation, (cite).

This data is a high-quality state-level dataset.

For consistency, the values in this study have been compared to the IPCC default waste breakdown for North America. Relevant values were found to be consistent within 90% confidence intervals (as reported in the MPCA study), with the exception of food waste. IPCC values attribute 33.9% of landfill waste to food waste, while the 2013 report only finds that 17.8% of landfill waste is food waste. There are many possible explanations for this discrepancy, including differences in waste breakdown across the North American region and the possibility that the IPCC's numbers reflect additional food waste processed in organics facilities, which would not be included in the MPCA study.

Due to the fact that it is more recent and more specific to the Minnesota region, we have chosen the MPCA study as the source of truth in this case.

<!-- If necessary, display final breakdown of percentages aligned with DOC calculation categories here. -->

{{< include data_wi_emissions.qmd >}}

### EPA Methane Recovery Data {#sec-epa-methane}

The EPA generates methane flaring and landfill gas to energy data for each state as part of its State Inventory Tool for solid waste. This data is collected as part of the [Landfill Methane Outreach Program](https://www.epa.gov/lmop). 

However, since this data is collected on a national level, there are potential discrepancies with state-level and especially regional breakdowns of methane recovery. Due to these concerns, we have chosen to exclude this data source from our inventory and instead use the IPCC default of 0 methane recovery. This means that our inventory may overestimate emissions from solid waste landfills.

## Graphing

Timeseries of categories over time, across the whole MN area.

```{r fig-sw-timeseries}
#| fig-cap: "Solid waste changes over time, 9-county MN region"
#| out-width: "95%"
sw_total_geog <- sw_emissions %>%
  group_by(sector, category, year, source) %>%
  summarize(emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e))

fig_solid_waste_time <-
  plot_ly(
    type = "bar",
    source = "fig-sw-timeseries",
    data = sw_total_geog,
    y = ~emissions_metric_tons_co2e,
    x = ~year,
    color = ~source,
    colors = unlist(management_method_colors),
    marker = list(
      line = list(
        width = 0
      )
    ),
    hovertemplate = ~ paste0(
      category, ", ", source, "<br>",
      round(emissions_metric_tons_co2e / 1000, digits = 0), " thousand metric tons CO<sub>2</sub>e", "<br>",
      "<extra></extra>"
    )
  ) %>%
  plotly_layout(
    main_title = "Solid Waste Emissions MN Counties 2005-2021",
    subtitle = "",
    y_title = "Metric tons CO<sub>2</sub>e",
    x_title = "Year",
    legend_title = "Category"
  ) %>%
  layout(
    barmode = "stack",
    legend = list(
      traceorder = "reversed"
    ),
    yaxis = list(categoryorder = "total ascending")
  )
fig_solid_waste_time
```

Total emissions appear to be decreasing to 2013 and then increasing again. This may be due to population change. A graph of emissions per capita could help explore this.

Comparing 2021 waste data (this run) with previous waste data and NEI data, to test consistency. Note that this version of solid waste data excludes methane recovery, so emissions may be slightly higher in some cases than expected.

```{r fig-solid-waste-versions-compare}
#| fig-cap:  "Solid waste emissions comparison: Met Council and US GHG Inventory"
#| out-width: "95%"

solidwaste_totals_prev <- county_emissions_old %>%
  filter(category == "Solid waste") %>%
  group_by(geog_name) %>%
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  )

solidwaste_totals_new <- sw_emissions %>%
  filter(year == 2021) %>%
  group_by(geog_name) %>%
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  ) %>%
  mutate(data_source = "Met Council V2")

waste_federal <- solidwaste_totals_prev %>%
  mutate(data_source = "Met Council V1") %>%
  bind_rows(solidwaste_totals_new) %>%
  bind_rows(federal_totals)

fig_sw_versions_compare <- plot_ly(
  data = waste_federal,
  source = "fig-solid-waste-versions-compare",
  x = ~geog_name,
  y = ~emissions_metric_tons_co2e,
  color = ~data_source,
  type = "bar",
  colors = c(
    "Met Council V1" = colors$councilBlue,
    "Met Council V2" = cprg_colors$cprg_green,
    "US GHG Inventory" = cprg_colors$cprg_da_yellow
  ),
  hovertemplate = ~ paste0(
    geog_name, " County", "<br>",
    data_source, "<br>",
    round(emissions_metric_tons_co2e * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison",
    subtitle = "Met Council estimates compared to US GHG Inventory",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Emissions Source"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_versions_compare
```

Total emissions per county comparing 2005 vs 2021

```{r fig-solid-waste-compare-years}
#| fig-cap:  "Solid waste emissions comparison: 2005 vs 2021"
#| out-width: "95%"

solidwaste_totals_year <- sw_emissions %>%
  filter(year %in% c(2005, 2021)) %>%
  group_by(geog_name, year) %>%
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  ) %>%
  mutate(
    year = as.factor(year)
  )

fig_sw_compare_years <- plot_ly(
  data = solidwaste_totals_year,
  source = "fig-solid-waste-compare-years",
  x = ~geog_name,
  y = ~emissions_metric_tons_co2e,
  color = ~year,
  type = "bar",
  colors = c(
    `2021` = colors$councilBlue,
    `2005` = cprg_colors$cprg_green
  ),
  hovertemplate = ~ paste0(
    geog_name, " County", "<br>",
    year, "<br>",
    round(emissions_metric_tons_co2e * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison 2005 vs 2021",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Year"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_compare_years
```

Landfill emissions by population - graphed to diagnose issue with methane recovery data

```{r fig-landfill-by-pop}
#| fig-cap: "Landfill emissions by population"
#| out-width: "95%"
cprg_pop_mn <- cprg_population %>%
  filter(STATE == "Minnesota")

landfill_emissions <- sw_emissions %>%
  filter(
    source == "Landfill",
    year == 2021
  ) %>%
  full_join(cprg_pop_mn, by = join_by(geog_name == NAME))

fig_landfill_by_pop <- plot_ly(
  data = landfill_emissions,
  x = ~population,
  y = ~emissions_metric_tons_co2e,
  source = "fig-landfill-by-pop",
  type = "scatter",
  mode = "markers",
  hoverinfo = "text",
  hovertemplate = ~ paste0(
    "County: ", geog_name, "<br>",
    "Waste generated: ", round(emissions_metric_tons_co2e / 1000), " thousand tons", "<br>",
    "Population: ", round(population),
    "<extra></extra>"
  ),
  marker = list(
    size = 18,
    color = colors$councilBlue,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "Landfill Emissions by county population, 2021",
    x_title = "Population",
    y_title = "Emissions (Metric Tons CO<sub>2</sub>E)"
  )
fig_landfill_by_pop
```
