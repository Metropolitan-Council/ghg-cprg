## Wastewater
```{r}
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_quarto_helpers.R"))
# pull data here
epa_ww <- readRDS(file.path(here::here(), "_waste/data/epa_county_wastewater.RDS"))
mpca_ww <- readRDS(file.path(here::here(), "_waste/data-raw/wastewater/epa_wastewater.RDS"))
mc_ww <- readRDS(file.path(here::here(), "_waste/data-raw/wastewater/metc_wastewater.RDS"))


mc_ww_cty <- mc_ww %>%
  group_by(year, COUNTY_NAM, scope) %>%
  summarize(co2e = sum(emissions_metric_tons_co2e), .groups = "keep") %>%
  filter(year == 2021 & scope == "Scope 1")

hookaddcap()
```

We currently have three sources for wastewater emissions: the EPA state inventory and projection tool, the Minnesota Pollution Control Agency (MPCA) emissions inventory, and Metropolitan Council Environmental Services emission estimates. Because only the EPA's estimate extends to Wisconsin and Minnesota we are reporting those data for consistency, but explore all three below where they have geographic overlap. The EPA estimate uses state population, biochemical oxygen demand, fraction of wastewater anaerobically digested, fraction of population on septic, estimated protein content, and biosolids used as fertilizer to estimate CH~4~ and N~2~O emissions [@usepaStateGreenhouseGas2024]. These inputs are modifiable and should be explored further in the CCAP. We down-scaled the state level emission estimates to county levels by population percentage.

- Data is the highest quality rank (federal agency)
- Data is modeled by the agencies based on multiple parameters, including population, aerobic vs anaerobic treatment use, and a variety of other factors.
- If this is a modeled dataset, what is the sample? UNCLEAR
- Output data is CO~2~ equivalencies in metric tons. We confirmed that the global warming potentials (GWP) used are from AR5 [@ipccClimateChange2014].
- EPA data is accessible [on the EPA website](https://www.epa.gov/statelocalenergy/download-state-inventory-and-projection-tool)
  MPCA data is accessible via their Tableau dashboard found [here](https://public.tableau.com/app/profile/mpca.data.services/viz/GHGemissioninventory/GHGsummarystory)
- We are currently using all default input values provided by the EPA, though will refine these based on our knowledge of local wastewater treatment in the future.
- Data is the 2020 statewide estimates downscaled to the county level by population percentage.
- This is the latest data available for both datasets (accessed January 2024, version 2024.1).
- We compare estimates from the MPCA and Met Council at the county level.

Be sure to add a citation of this dataset to the Zotero shared library.

### Data characteristics

There are many sources of uncertainty in these estimates due to multiple activity data inputs required for CH~4~ and N~2~O emission estimates. The EPA Wastewater module does not offer guidance on quantifying these sources of uncertainty, only describing the potential sources themselves.

### Limitations

- In order to have homogeneous comparisons among counties, we are relying on default EPA State Inventory Tool data which may miss particularities about how wastewater is processed in our narrower county scope.
- We are assuming EPA default input values are appropriate representations of the 11 county MSA region and that we can scale to county levels by population given that we are estimating municipal wastewater treatment.


### Comparison with similar datasets

The Metropolitan Council, MPCA, and EPA source data leads to different estimates of emissions in the common seven county region. The Metropolitan Council does not process all wastewater in the seven county region. Additionally, they report CO~2~ emissions from combustion of stationary fuels for infrastructure used in directly processing wastewater, unlike EPA estimates which are CH~4~ and N~2~O emissions from municipal wastewater treatment of organic matter.

```{r fig-wastewater-source-comparison}
#| fig-cap: "Total waste generated by county"
#| out-width: "95%"

comp_2021 <- bind_rows(
  mc_ww_cty %>%
    mutate(county_name = COUNTY_NAM, source = "Met Council") %>%
    ungroup() %>%
    select(-c(year, scope, COUNTY_NAM)),
  mpca_ww %>%
    mutate(county_name = NAME, source = "MPCA", co2e = state_co2e) %>%
    ungroup() %>%
    select(-c(GEOID, NAME, state_co2e, epa_co2e)),
  epa_ww %>%
    mutate(county_name = NAME, source = "EPA", co2e = epa_co2e) %>%
    ungroup() %>%
    select(-c(GEOID, NAME, epa_co2e))
)

comp_2021 %>%
  filter(county_name %in% mc_ww_cty$COUNTY_NAM) %>%
  plot_ly(
    x = ~ reorder(county_name, -co2e),
    y = ~co2e,
    source = opts_current$get()$label,
    type = "bar",
    hoverinfo = "text",
    color = ~source,
    hovertemplate = ~ paste0(
      "County: ", county_name, "<br>",
      "Data source: ", source, "<br>",
      "Emissions: ", scales::comma(round(co2e)), " metric tons CO<sub>2</sub>e",
      "<extra></extra>"
    )
  ) %>%
  plotly_layout(
    main_title = "County wastewater emissions by source",
    x_title = "County",
    y_title = "CO<sub>2</sub>e emissions (metric tons)",
    legend_title = "Data source",
    barmode = "identity"
  ) %>%
  layout(
    barmode = "identity"
  )
```

### Data dictionary

Table with detailed description of columns and definitions for each data table.

Code reviewer: Liz Roten

```{r echo=FALSE}
caption_index <- readRDS(file.path(here::here(), "caption_index.RDS"))
caption_index <- as.character(as.numeric(caption_index) + 1) %>% stringr::str_pad(width = 2, side = "left", pad = "0")
saveCap(paste0("cap-", caption_index))
saveRDS(caption_index, file.path(here::here(), "caption_index.RDS"))
```
