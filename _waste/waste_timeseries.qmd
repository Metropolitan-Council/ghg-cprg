```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))
cprg_population <- readRDS(file.path(here::here(), "_meta/data/cprg_population.RDS"))
epa_waste_inventory <- readRDS(file.path(here::here(), "_waste/data-raw/epa_solidwaste_inventory.RDS"))

federal_totals <- epa_waste_inventory %>%
  filter(source == "Total") %>%
  select(
    geog_name,
    source,
    emissions_metric_tons_co2e,
    data_source
  )

cprg_ctu <- readRDS(file.path(here::here(), "_meta/data/cprg_ctu.RDS"))
sw_emissions <- readRDS(file.path(here::here(), "_waste/data/mn_sw_emissions_co2e.RDS"))
county_emissions_old <- readRDS(file.path(here::here(), "_meta/data/cprg_county_emissions.RDS"))
hookaddcap()
```

# Graphing

Timeseries of categories over time, across the whole MN area. 
FOR REVIEWER: Should this be filtered to the 7-county region for RDG purposes?
```{r fig-sw-timeseries}
sw_total_geog <- sw_emissions %>% 
  group_by(sector, category, year, source) %>% 
  summarize(emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e))

fig_solid_waste_time <-
  plot_ly(
    type = "bar",
    source = "fig-sw-timeseries",
    data = sw_total_geog,
    y = ~ emissions_metric_tons_co2e,
    x = ~year,
    color = ~source,
    colors = unlist(management_method_colors),
    marker = list(
      line = list(
        width=0
      )
    ),
    hovertemplate = ~ paste0(
      category, ", ", source, "<br>",
      round(emissions_metric_tons_co2e / 1000, digits = 0), " thousand metric tons CO<sub>2</sub>e", "<br>",
      "<extra></extra>"
    )
  ) %>%
  plotly_layout(
    main_title = "Solid Waste Emissions MN Counties 2005-2021",
    subtitle = "",
    y_title = "Metric tons CO<sub>2</sub>e",
    x_title = "Year",
    legend_title = "Category"
  ) %>%
  layout(
    barmode = "stack",
    legend = list(
      traceorder = "reversed"
    ),
    yaxis = list(categoryorder = "total ascending")
  )
fig_solid_waste_time
```
Total emissions appear to be decreasing to 2013 and then increasing again. This may be due to population change. A graph of emissions per capita could help explore this. 


Comparing 2021 waste data (this run) with previous waste data and NEI data, to test consistency. Note that this version of solid waste data excludes methane recovery, so emissions may be slightly higher in some cases than expected.

```{r fig-solid-waste-versions-compare}
#| fig-cap:  "Solid waste emissions comparison: Met Council and US GHG Inventory"
#| out-width: "95%"

solidwaste_totals_prev <- county_emissions_old %>%
  filter(category == "Solid waste") %>%
  group_by(geog_name) %>%
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  )

solidwaste_totals_new <- sw_emissions %>% 
  filter(year == 2021) %>% 
  group_by(geog_name) %>% 
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  ) %>% 
  mutate(data_source = "Met Council V2")

waste_federal <- solidwaste_totals_prev %>%
  mutate(data_source = "Met Council V1") %>%
  bind_rows(solidwaste_totals_new) %>% 
  bind_rows(federal_totals)

fig_sw_versions_compare <- plot_ly(
  data = waste_federal,
  source = "fig-solid-waste-versions-compare",
  x = ~geog_name,
  y = ~emissions_metric_tons_co2e,
  color = ~data_source,
  type = "bar",
  colors = c(
    "Met Council V1" = colors$councilBlue,
    "Met Council V2" = cprg_colors$cprg_green,
    "US GHG Inventory" = cprg_colors$cprg_da_yellow
  ),
  hovertemplate = ~ paste0(
    geog_name, " County", "<br>",
    data_source, "<br>",
    round(emissions_metric_tons_co2e * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison",
    subtitle = "Met Council estimates compared to US GHG Inventory",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Emissions Source"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_versions_compare
```


Total emissions per county comparing 2005 vs 2021

```{r fig-solid-waste-compare-years}
#| fig-cap:  "Solid waste emissions comparison: 2005 vs 2021"
#| out-width: "95%"

solidwaste_totals_year <- sw_emissions %>% 
  filter(year %in% c(2005, 2021)) %>% 
  group_by(geog_name, year) %>% 
  summarise(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e)
  ) %>% 
  mutate(
    year = as.factor(year)
  )

fig_sw_compare_years <- plot_ly(
  data = solidwaste_totals_year,
  source = "fig-solid-waste-compare-years",
  x = ~geog_name,
  y = ~emissions_metric_tons_co2e,
  color = ~year,
  type = "bar",
  colors = c(
    `2021` = colors$councilBlue,
    `2005` = cprg_colors$cprg_green
  ),
  hovertemplate = ~ paste0(
    geog_name, " County", "<br>",
    year, "<br>",
    round(emissions_metric_tons_co2e * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison 2005 vs 2021",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Year"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_compare_years
```

Landfill emissions by population - graphed to diagnose issue with methane recovery data

```{r fig-landfill-by-pop}

cprg_pop_mn <- cprg_population %>%
  filter(STATE == "Minnesota")

landfill_emissions <- sw_emissions %>%
  filter(source == "Landfill",
         year == 2021) %>%
  full_join(cprg_pop_mn, by = join_by(geog_name == NAME))

fig_landfill_by_pop <- plot_ly(
  data = landfill_emissions,
  x = ~population,
  y = ~emissions_metric_tons_co2e,
  source = "fig-landfill-by-pop",
  type = "scatter",
  mode = "markers",
  hoverinfo = "text",
  hovertemplate = ~ paste0(
    "County: ", geog_name, "<br>",
    "Waste generated: ", round(emissions_metric_tons_co2e / 1000), " thousand tons", "<br>",
    "Population: ", round(population),
    "<extra></extra>"
  ),
  marker = list(
    size = 18,
    color = colors$councilBlue,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "Landfill Emissions by county population, 2021",
    x_title = "Population",
    y_title = "Emissions (Metric Tons CO<sub>2</sub>E)"
  )
fig_landfill_by_pop

```

