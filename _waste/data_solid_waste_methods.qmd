```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))
cprg_population <- readRDS(file.path(here::here(), "_meta/data/cprg_population.RDS"))
epa_waste_inventory <- readRDS(file.path(here::here(), "_waste/data-raw/compare_epa_inventory.RDS"))

federal_totals <- epa_waste_inventory %>%
  filter(source == "Total") %>%
  select(
    geoid,
    source,
    value_emissions,
    data_source
  )

cprg_ctu <- readRDS(file.path(here::here(), "_meta/data/cprg_ctu.RDS"))
solid_waste <- readRDS(file.path(here::here(), "_waste/data/final_solid_waste_allyrs.RDS"))
waste_emissions_old <- readRDS(file.path(here::here(), "_waste/data/solid_waste_2021.RDS"))
hookaddcap()
```

## Methods

Solid waste emissions for Minnesota and Wisconsin are calculated using two different methods due to a difference in data availability. 

### Minnesota

The previous iteration of this inventory calculated Minnesota's solid waste emissions by multiplying activity totals by emissions factors from the EPA's Emissions Factor Hub. This update instead uses methodologies recommended by the Intergovernmental Panel on Climate Change (IPCC) (cite).The methodologies were selected to align with best practices for community-wide inventories using the IPCC recommendations and the guidance of the Global Protocol for Community-Scale Greenhouse Gas Inventories (cite).

#### Landfill

The IPCC suggests two alternatives for calculating landfill emissions, a first order decay model and a methane commitment model. The first order decay model is often used for larger-scale inventories, such as the US Federal Inventory, and requires waste data going back to 1950. Given the data available and the scope of this inventory, we chose to instead use the simpler methane commitment model to calculate county-level emissions for Minnesota.

The methane commitment model calculates methane emissions from landfills for a given year by multiplying municipal solid waste totals by a methane generation potential and adjusting for oxidation and methane flaring,

$$Emissions_{CH_4} = [(MSW \times L_0 )-rec] \times (1 – ox) $$

$MSW$, or the amount of municipal solid waste processed in landfills, is reported on a county level by MPCA's SCORE report (@sec-mpca-score).
<!-- make sure the above link refers to the most current information! -->
It is then multiplied by a methane generation potential $L_0$. In some processes, the amount of methane recovered from landfills, either through methane flaring or landfill gas to energy programs, is subtracted here. Due to data concerns and best practices recommendations, we have chosen not to include methane recovery in our Minnesota emissions calculations. Learn more in @sec-epa-methane. 

After subtracting methane recovered, emissions are multiplied by $1-ox$ to account for oxidation in the landfill. Our oxidation value is assigned the IPCC default of 0.1.

$L_0$, the methane generation potential, is calculated as follows:

$$L_0 = MCF × DOC_f × F × 16/12 \times DOC$$ where

-   $MCF$ = methane commitment factor. Assigned IPCC default of 0.5 for managed, semi-aerobic landfills.
-   $DOC_f$ = fraction of degradable organic carbon degraded. Assigned IPCC default of 0.6.
-   $F$ = fraction of methane in landfill gas. Assigned IPCC default of 0.5.
-   $16/12$ = ??
-   $DOC$ = degradable organic carbon. Calculated based on local waste makeup data from MPCA's [2013 Statewide Waste Characterization study](https://www.pca.state.mn.us/sites/default/files/w-sw1-60.pdf), using the equation $DOC = ( 0.4 \times \text{paper/textiles}) + ( 0.17 \times \text{non-food organics}) + ( 0.15 \times \text{food waste}) + ( 0.3 \times \text{wood/straw})$.

#### Compost

Compost produces both methane and nitrous oxide. Emissions are calculated by multiplying waste activity totals by emissions factors divided between aerobic and anaerobic digesters. Since Minnesota only has one anaerobic digester, we assumed 0% anaerobic digestion in the inventory area (source).

$$Emissions_{CH_4} = MSW_{compost} \times 10 \times 10^{-3}$$

$$Emissions_{N_2O} = MSW_{compost} \times 0.6 \times 10^{-3}$$

As in other sections, MSW activity data comes from MPCA's SCORE report. The emissions factors of 10 and 0.6 come from IPCC default values.

#### Incineration

Since incineration data is reported to SCORE as Waste to Energy, it is assumed that all incineration in the MSA is considered Waste to Energy.

Incineration of waste produces CH~4~, CO~2~, and N~2~O emissions. However, the Global Protocol for Community-Scale Greenhouse Gas Emission Inventories reports negligible CH~4~ emissions for continuous incineration facilities. 
<!-- \[CHECK IF WE USE STOKERS OR FLUIDIZED BEDS - STOKER EF \~0.2\] -->

$$Emissions_{CO_2} = (MSW_{incinerated} \times E_i + MSW_{onsite} \times E_o) \times FCC
\times FFC \times 44/12$$

$$Emissions_{N_2O} = MSW_{incinerated} \times EF_{N_2O} \times 10^{-6}$$

where:

-   $MSW_{incinerated}$ = municipal solid waste incinerated, as reported by SCORE.

-   $E_i$ = efficiency of combustion for incineration. Assigned IPCC default of 95%.

-   $MSW_{onsite}$ = municipal solid waste burned onsite, as reported by SCORE.

-   $E_o$ = efficiency of combustion for onsite burning. Assigned Greenhouse Gas Protocol default of 71%.

-   $FCC$ = fraction of carbon content in MSW. Assigned IPCC default of 40%.

-   $FFC$ = fraction of fossil carbon in MSW. Assigned IPCC default of 40%.

-   $EF_{N_2O}$ = aggregate N~2~O emission factor for MSW. Assigned GHG Protocol default of 50 g N~2~O/ metric tons waste for continuous and semi-continuous incinerators.

#### Limitations

Because the methane commitment method for landfill emissions calculates emissions slightly differently than the IPCC-encouraged First Order Decay model, landfill results may differ slightly from sources that use First Order Decay, such as the EPA's National Inventory and its State Inventory Tools. Both methods are accepted as valid ways to estimate solid waste emissions.

MPCA SCORE does not report activity data for waste generated and processed by industry. 
<!-- [check SIT tool - what % does EPA assign industry?] -->

Emissions are not calculated for waste that is recycled, as any emissions generated in the recycling process come from the energy use of the facilities or transportation and are accounted for in other sectors of this inventory.

### Wisconsin

Wisconsin emissions are calculated by interpolating and scaling down state-level data from the Wisconsin DNR [@wisconsindnrGreenhouseGas2021].

This 2021 inventory estimates landfill and waste-to-energy emissions for the years 2005 and 2018, including methane recovery offsets. In order to fill in missing years, emissions between 2005 and 2018 were linearly interpolated. Due to the small amount of change in emissions, it was assumed that emissions from 2018 to 2021 were constant. These emissions were then allocated to counties based on population.


## Validation Graphs

Timeseries of categories over time, across the whole MN area.

```{r fig-sw-timeseries}
#| fig-cap: "Solid waste changes over time, 9-county MN region"
#| out-width: "95%"
sw_total_geog <- solid_waste %>%
  group_by(sector, category, inventory_year, source) %>%
  summarize(value_emissions = sum(value_emissions))

fig_solid_waste_time <-
  plot_ly(
    type = "bar",
    source = "fig-sw-timeseries",
    data = sw_total_geog,
    y = ~value_emissions,
    x = ~inventory_year,
    color = ~source,
    colors = unlist(management_method_colors),
    marker = list(
      line = list(
        width = 0
      )
    ),
    hovertemplate = ~ paste0(
      category, ", ", source, "<br>",
      round(value_emissions / 1000, digits = 0), " thousand metric tons CO<sub>2</sub>e", "<br>",
      "<extra></extra>"
    )
  ) %>%
  plotly_layout(
    main_title = "Solid Waste Emissions MN Counties 2005-2021",
    subtitle = "",
    y_title = "Metric tons CO<sub>2</sub>e",
    x_title = "Year",
    legend_title = "Category"
  ) %>%
  layout(
    barmode = "stack",
    legend = list(
      traceorder = "reversed"
    ),
    yaxis = list(categoryorder = "total ascending")
  )
fig_solid_waste_time
```

Total emissions appear to be decreasing to 2013 and then increasing again. This may be due to population change. A graph of emissions per capita could help explore this.

Comparing 2021 waste data (this run) with previous waste data and NEI data, to test consistency. Note that this version of solid waste data excludes methane recovery, so emissions may be slightly higher in some cases than expected.

```{r fig-solid-waste-versions-compare}
#| fig-cap:  "Solid waste emissions comparison: Met Council and US GHG Inventory"
#| out-width: "95%"

solidwaste_totals_prev <- waste_emissions_old %>%
  group_by(geoid) %>%
  summarise(
    value_emissions = sum(value_emissions)
  )

solidwaste_totals_new <- solid_waste %>%
  filter(inventory_year == 2021) %>%
  group_by(geoid) %>%
  summarise(
    value_emissions = sum(value_emissions)
  ) %>%
  mutate(data_source = "Met Council V2")

waste_federal <- solidwaste_totals_prev %>%
  mutate(data_source = "Met Council V1") %>%
  bind_rows(solidwaste_totals_new) %>%
  bind_rows(federal_totals)

fig_sw_versions_compare <- plot_ly(
  data = waste_federal,
  source = "fig-solid-waste-versions-compare",
  x = ~geoid,
  y = ~value_emissions,
  color = ~data_source,
  type = "bar",
  colors = c(
    "Met Council V1" = colors$councilBlue,
    "Met Council V2" = cprg_colors$cprg_green,
    "US GHG Inventory" = cprg_colors$cprg_da_yellow
  ),
  hovertemplate = ~ paste0(
    geoid, " County", "<br>",
    data_source, "<br>",
    round(value_emissions * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison",
    subtitle = "Met Council estimates compared to US GHG Inventory",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Emissions Source"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_versions_compare
```

Total emissions per county comparing 2005 vs 2021

```{r fig-solid-waste-compare-years}
#| fig-cap:  "Solid waste emissions comparison: 2005 vs 2021"
#| out-width: "95%"

solidwaste_totals_year <- solid_waste %>%
  filter(inventory_year %in% c(2005, 2021)) %>%
  group_by(geoid, inventory_year) %>%
  summarise(
    value_emissions = sum(value_emissions)
  ) %>%
  mutate(
    inventory_year = as.factor(inventory_year)
  )

fig_sw_compare_years <- plot_ly(
  data = solidwaste_totals_year,
  source = "fig-solid-waste-compare-years",
  x = ~geoid,
  y = ~value_emissions,
  color = ~inventory_year,
  type = "bar",
  colors = c(
    `2021` = colors$councilBlue,
    `2005` = cprg_colors$cprg_green
  ),
  hovertemplate = ~ paste0(
    geoid, " County", "<br>",
    inventory_year, "<br>",
    round(value_emissions * 1e-3, digits = 0),
    " thousand metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  councilR::plotly_layout(
    main_title = "Solid waste emissions comparison 2005 vs 2021",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Year"
  ) %>%
  plotly::layout(barmode = "group")

fig_sw_compare_years
```

Landfill emissions by population - graphed to diagnose issue with methane recovery data

```{r fig-landfill-by-pop}
#| fig-cap: "Landfill emissions by population"
#| out-width: "95%"
cprg_pop_mn <- cprg_population %>%
  filter(STATE == "Minnesota")

landfill_emissions <- solid_waste %>%
  filter(
    source == "Landfill",
    inventory_year == 2021
  ) %>%
  full_join(cprg_pop_mn, by = join_by(geoid == GEOID))

fig_landfill_by_pop <- plot_ly(
  data = landfill_emissions,
  x = ~population,
  y = ~value_emissions,
  source = "fig-landfill-by-pop",
  type = "scatter",
  mode = "markers",
  hoverinfo = "text",
  hovertemplate = ~ paste0(
    "County: ", NAME, "<br>",
    "Waste generated: ", round(value_emissions / 1000), " thousand tons", "<br>",
    "Population: ", round(population),
    "<extra></extra>"
  ),
  marker = list(
    size = 18,
    color = colors$councilBlue,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
) %>%
  plotly_layout(
    main_title = "Landfill Emissions by county population, 2021",
    x_title = "Population",
    y_title = "Emissions (Metric Tons CO<sub>2</sub>E)"
  )
fig_landfill_by_pop
```
