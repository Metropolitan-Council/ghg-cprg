# Waste and Wastewater 
```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))

cprg_ctu <- readRDS(file.path(here::here(), "_meta/data/cprg_ctu.RDS"))
county_emissions <- readRDS(file.path(here::here(), "_meta/data/cprg_county_emissions.RDS"))

county_emissions_summary <- county_emissions %>%
  group_by(sector, category, source, data_source, factor_source) %>%
  summarize(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e),
    .groups = "keep"
  )
hookaddcap()
```

## Introduction

## Methods

### Wastewater


```{r fig-waste-county-emissions}
#| fig-cap: "Waste county emissions"
#| out-width: "95%"
fig_waste_county_emissions <- plot_county_sector_emissions(county_emissions,
  .sector = "Waste",
  .plotly_source = "fig-waste-county-emissions"
)
fig_waste_county_emissions
```


```{r fig-waste-county-emissions-by-category}
#| fig-cap: "Waste and wastewater county level emissions"
#| out-width: "95%"

fig_waste_county_emissions_by_category <- plot_county_emissions(
  county_emissions = county_emissions,
  .sector = "Waste",
  .plotly_source = "fig-waste-county-emissions-by-category"
)
fig_waste_county_emissions_by_category
```

Wastewater data come from two sources - the Metropolitan Council Environmental Services Division and [xxx]. 

Data here are categorized into Scope 1, emissions directly from wastewater activities, and Scope 2, emissions based on electrical purchases.


```{r fig-mn-county-ww-emissions}
#| fig-cap: "County aggregated wastewater emissions by scope"
#| out-width: "95%"

metc_ww <- readRDS(file.path(here::here(), "_waste/data-raw/wastewater/metc_wastewater.RDS")) %>%
  filter(year == 2021)

metc_ww_summary <- metc_ww %>%
  group_by(COUNTY_NAM, year, scope) %>%
  summarize(
    emissions_metric_tons_co2e = sum(emissions_metric_tons_co2e),
    .groups = "keep"
  )

fig_mn_county_ww_emissions <- plot_ly(
  data = metc_ww_summary,
  x = ~ reorder(COUNTY_NAM, -emissions_metric_tons_co2e),
  y = ~emissions_metric_tons_co2e,
  source = "fig-mn-county-ww-emissions",
  color = ~scope,
  type = "bar",
  hovertemplate = ~ paste0(
    COUNTY_NAM, " County", "<br>",
    scope, "<br>",
    round(emissions_metric_tons_co2e * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  plotly_layout(
    main_title = "County wastewater emissions by scope",
    x_title = "County",
    y_title = "Metric tons CO<sub>2</sub>e"
  ) %>%
  layout(
    barmode = "stack",
    legend = list(
      traceorder = "normal"
    )
  )

fig_mn_county_ww_emissions
```


## Results



```{r echo=FALSE}
caption_index <- readRDS(file.path(here::here(), "caption_index.RDS"))
caption_index <- as.character(as.numeric(caption_index) + 1) %>% stringr::str_pad(width = 2, side = "left", pad = "0")
saveCap(paste0("cap-", caption_index))
saveRDS(caption_index, file.path(here::here(), "caption_index.RDS"))
```
{{< pagebreak >}}
