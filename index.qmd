# Executive summary {.unnumbered}
```{r}
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))

county_emissions <- readRDS(file.path(here::here(), "_meta/data/cprg_county_emissions.RDS")) %>% 
  mutate(sector = factor(sector,
                             levels = c(            
                               "Transportation",            
                               "Residential",             
                               "Commercial",             
                               "Industrial",              
                               "Waste",                
                               "Agriculture",              
                               "Natural Systems")))
                                                     

county_emissions_summary_2021 <- county_emissions %>%
  filter(emissions_year == 2021) %>% 
  group_by(sector, category, source, data_source, factor_source) %>%
  summarize(
    value_emissions = sum(value_emissions),
    emissions_per_capita = sum(emissions_per_capita),
    .groups = "keep"
  )

county_emissions_summary_2005 <- county_emissions %>%
  filter(emissions_year == 2005) %>% 
  group_by(sector, category, source, data_source, factor_source) %>%
  summarize(
    value_emissions = sum(value_emissions),
    .groups = "keep"
  ) %>% 
  filter(!is.na(value_emissions)) #commercial natural gas from MPCA is NA

hookaddcap()
```

*This project has been funded wholly or in part by the United States Environmental Protection Agency (EPA) under assistance agreement 00E03476 to the Metropolitan Council. The contents of this document do not necessarily reflect the views and policies of the EPA, nor does the EPA endorse trade names or recommend the use of commercial products mentioned in this document.*

::: {.callout-note}
This document will be updated continuously in preparation of the Metropolitan Council Comprehensive Climate Action Plan (CCAP). Please check back occasionally as we update modify and add new content. 
:::

```{r sector-percentages, echo=FALSE, include=FALSE}
sector_percentages <- county_emissions_summary_2021 %>%
  filter(
    !sector == "Natural Systems"
  ) %>% # not contributing to emissions
  group_by(sector) %>%
  summarize(value_emissions = sum(value_emissions)) %>%
  arrange(-value_emissions) %>%
  janitor::adorn_percentages(denominator = "col")

sector_percentages

emissions_total <- sum(county_emissions_summary_2021$value_emissions[county_emissions_summary_2021$sector != "Natural Systems"])
seq_total <- (-1 * sum(county_emissions_summary_2021$value_emissions[county_emissions_summary_2021$sector == "Natural Systems"]))

seq_percentage <- (-1 * sum(county_emissions_summary_2021$value_emissions[county_emissions_summary_2021$sector == "Natural Systems"])) / sum(county_emissions_summary_2021$value_emissions[county_emissions_summary_2021$sector != "Natural Systems"])

emissions_2005 <- sum(county_emissions_summary_2005$value_emissions[county_emissions_summary_2005$sector != "Natural Systems"])

electricity_2021 <- county_emissions_summary_2021 %>% 
  filter(category == "Electricity") %>% 
  pull(value_emissions) %>% 
  sum()
  
electricity_2005 <- county_emissions_summary_2005 %>% 
  filter(category == "Electricity") %>% 
  pull(value_emissions) %>% 
  sum()

```

In 2021, the Twin-Cities MSA generated `r round(emissions_total/1000000, digits = 2)` million metric tons CO~2~ equivalent (MMtCO~2~e) emissions from energy, transportation, and waste sectors. `r sector_percentages[[1]][1]` was the largest contributor to GHG emissions (`r scales::percent(sector_percentages[[2]][1], accuracy = 0.1)`), followed by `r sector_percentages[[1]][2]` (`r scales::percent(sector_percentages[[2]][2], accuracy = 0.1)`), and `r sector_percentages[[1]][3]` (`r scales::percent(sector_percentages[[2]][3], accuracy = 0.1)`). Carbon sequestration from natural systems offset `r scales::percent(seq_percentage, accuracy = 0.1)` of total emissions.

```{r fig-county-emissions-sector}
#| fig-cap: "County emissions by sector and category"
#| out-width: "95%"

county_emissions_2021 <- county_emissions %>% 
  filter(emissions_year == 2021) %>% 
  mutate(category = if_else(category %in% c("Building Fuel",
                                            "Electricity"),
                            source, category))

# reorder to put sequestration at end
county_emissions_2021$sector <- factor(county_emissions_2021$sector,
  levels = c("Transportation", "Residential", "Commercial", "Industrial", "Waste", "Agriculture", "Nature")
)

fig_county_emissions_sector <- plot_ly(
  data = county_emissions_2021 %>%
    group_by(sector, category) %>%
    summarize(
      value_emissions = sum(value_emissions),
      .groups = "keep"
    ),
  source = "fig-county-emissions-sector",
  x = ~sector,
  y = ~value_emissions,
  color = ~category,
  colors = unlist(category_colors),
  split = ~category,
  type = "bar",
  hovertemplate = ~ paste0(
    category, "<br>",
    round(value_emissions * 1e-6, digits = 2), " million metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  )
) %>%
  plotly_layout("11-county regional greenhouse gas emissions, 2021",
    subtitle = "",
    x_title = "Sector",
    y_title = "Metric tons CO<sub>2</sub>e",
    legend_title = "Category",
    barmode = "stack"
  )

fig_county_emissions_sector
```


## Emissions through time

Emissions in the region fell by `r scales::percent((emissions_2005 - emissions_total) / emissions_2005, accuracy = 0.1)` from 2005 to 2021. This is principally attributed to decarbonization of the electric grid, which fell `r scales::percent((electricity_2005 - electricity_2021) / electricity_2005, accuracy = 0.1)` from 2005 to 2021. Other sectors showed small increases or decreases.

```{r fig-temporal-emissions}

baseline_comparison_facet <- ggplot(county_emissions %>% 
                                filter(emissions_year >= 2005 & emissions_year <= 2021) %>% 
                                  group_by(sector, emissions_year) %>% 
                                  summarize(value_emissions = sum(value_emissions, na.rm = TRUE))
                                  ,
                              aes(x = emissions_year, y = value_emissions/1000000, 
                                  fill = sector,
                                  col = sector)) +
  geom_area(alpha = 0.4) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = 0, size = 1.2, col = "black", linetype = "dashed")+
  labs(fill = "sector") +
  ggtitle("Regional Emissions Inventory: 2005-2021") +
  scale_fill_manual(values = unlist(sector_colors), guide = "none") + 
  scale_color_manual(values = unlist(sector_colors), guide = "none") +
  theme_bw() + xlab("") + ylab(expression(paste("Million metric tons of ",CO[2],"e"))) +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size = 15, angle = -90, vjust = .25),
        text = element_text(size = 20, family="sans")) +
  facet_grid(. ~ sector)

baseline_comparison_facet

# problematic plotly attempt, return to later

# baseline_data <- county_emissions %>%
#   filter(emissions_year >= 2005 & emissions_year <= 2021) %>%
#   group_by(sector, emissions_year, category) %>%
#   summarize(value_emissions = sum(value_emissions, na.rm = TRUE), .groups = "drop") %>%
#   mutate(value_emissions = value_emissions / 1000000,
#          sector = factor(sector,
#                          levels = c(
#                            "Transportation", 
#                            "Residential",
#                            "Commercial",                  
#                            "Industrial",                 
#                            "Waste",                
#                            "Agriculture",                
#                            "Natural Systems")))
# 
# # Create plotly traces for each sector
# plot_list <- lapply(unique(baseline_data$sector), function(sector) {
#   sector_data <- filter(plot_data, sector == !!sector)
#   
#   plot_ly(sector_data, x = ~emissions_year, y = ~value_emissions, 
#           type = "scatter", mode = "lines", fill = "tozeroy",
#           color = ~category,
#           colors = unlist(category_colors),
#           hoverinfo = "text",
#           text = ~paste0("Year: ", emissions_year, "<br>",
#                          "Emissions: ", round(value_emissions, 2), " MtCO2e<br>",
#                          "Category: ", category),
#           name = sector)
# })
# 
# # Arrange the plots in facets
# final_plot <- subplot(plot_list, nrows = length(sector_levels), shareX = TRUE, titleX = FALSE) %>%
#   layout(title = "Regional Emissions Inventory: 2005-2021",
#          yaxis = list(title = "Million metric tons of CO2e"),
#          shapes = list(
#            list(type = "line", x0 = 2005, x1 = 2021, y0 = 0, y1 = 0,
#                 line = list(color = "black", width = 1.2, dash = "dash"))
#          ))
# 
# final_plot

```


## County Emissions

Different counties have different emission profiles depending on land-use and community characteristics.

``` {r fig-county-emissions}

county_emissions_2021 <- county_emissions %>% 
      filter(emissions_year == 2021,
             county_name != "MSP Airport",
             sector != "Natural Systems") 

county_emissions_raw <- plot_ly(
    data = county_emissions_2021,
    type = "bar",
    source = "fig-county-emissions",
    x = ~county_name,
    y = ~value_emissions,
    color = ~sector,
    split = ~sector,
    colors = unlist(sector_colors),
    marker = list(
      line = list(
        width = 0
      )
    ),
    hovertemplate = ~ paste0(
      county_name, " County", "<br>",
      sector, " - ", category, ", ", source, "<br>",
      round_emissions_metric_tons_co2e(value_emissions),
      "<extra></extra>"
    )
  ) %>%
    plotly::layout(barmode = "stack")

county_emissions_raw

```

However, most emissiosn are closely tied to population and a per capita emissions profile shows a more even distribution.

``` {r fig-county-emissions-per-capita}


county_emissions_2021_per_capita <- plot_ly(
    data = county_emissions_2021,
    type = "bar",
    source = "fig-county-emissions-per-capita",
    x = ~county_name,
    y = ~emissions_per_capita,
    color = ~sector,
    split = ~sector,
    colors = unlist(sector_colors),
    marker = list(
      line = list(
        width = 0
      )
    ),
    hovertemplate = ~ paste0(
      county_name, " County", "<br>",
      sector, " - ", category, ", ", source, "<br>",
      round(emissions_per_capita),
      "<extra></extra>"
    )
  ) %>%
    plotly::layout(barmode = "stack")

county_emissions_2021_per_capita

```

#### REMOVE ALL SECTOR PROFILES BUT MAKE SURE THEY ARE IN THE SECTOR SUMMARY

## Emissions by sector



```{r fig-transportation-emissions}
#| fig-cap: "Transportation county level emissions"
#| out-width: "95%"
fig_transportation_emissions <- plot_county_emissions(
  county_emissions = county_emissions %>%
    filter(emissions_year == "2021"),
  .sector = "Transportation",
  .plotly_source = "fig-transportation-emissions"
)
fig_transportation_emissions
```

The transportation sector generated `r round(emissions_total/1000000 * sector_percentages[[2]][1], digits = 2)` MMtCO~2~e of emissions in the Twin Cities MSA in 2021. Passenger vehicles generate the most emissions by source, with heavy-duty vehicles and aviation following.

```{r fig-electricity-emissions}
#| fig-cap: "Transportation county level emissions"
#| out-width: "95%"

electricity_emissions <- county_emissions %>% 
  filter(emissions_year == "2021") %>% 
  mutate(sector = if_else(category == "Electricity",
         "Electricity", sector))

fig_electricity_emissions <- plot_county_emissions(
  electricity_emissions,
  .sector = "Electricity",
  .plotly_source = "fig-electricity-emissions"
)

fig_electricity_emissions
```

The electricity sector generated `r round(emissions_total/1000000 * sector_percentages[[2]][2], digits = 2)` MMtCO~2~e of emissions in the Twin Cities MSA in 2021. Of emissions from electricity, as estimated XX% come from the residential sector, YY% from the commercial sector, and ZZ% from the industrial sector.

```{r fig-building-emissions}
#| fig-cap: "Transportation county level emissions"
#| out-width: "95%"

building_emissions <- county_emissions %>% 
  filter(emissions_year == "2021") %>% 
  mutate(sector = if_else(category == "Building Fuel",
         "Building Fuel", sector))

fig_building_emissions <- plot_county_emissions(
  building_emissions,
  .sector = "Building Fuel",
  .plotly_source = "fig-electricity-emissions"
)

fig_building_emissions
```

Emissions from waste is the smallest of the three sectors in the Twin Cities MSA. Waste generated `r round(emissions_total/1000000 * sector_percentages[[2]][3], digits = 2)` MMtCO~2~e of emissions in the Twin Cities MSA in 2021. Solid waste, including landfills, recycling, and organics, generates the largest share of emissions in the waste sector, with wastewater treatment comprising a smaller share of waste emissions. 

```{r fig-waste-emissions-index}
#| fig-cap: "Waste and wastewater county level emissions"
#| out-width: "95%"
fig_waste_emissions_index <- plot_county_emissions(
  county_emissions = county_emissions,
  .sector = "Waste",
  .plotly_source = "fig-waste-emissions-index"
)

fig_waste_emissions_index$x$layoutAttrs[[1]]$title$text <- "Solid waste and wastewater emissions"

fig_waste_emissions_index
```

Potential sequestration from natural systems totaled `r round(seq_total/1000000, digits = 2)` MMtCO~2~e in the Twin Cities MSA in 2021. Urban forests and grasslands have high sequestration potential, though are expected to have lower stock potential, capping their potential carbon storage in the future.

```{r fig-nature-sequestration}
#| fig-cap: "Natural systems county level sequestration"
#| out-width: "95%"
fig_nature_sequestration <- plot_county_emissions(
  county_emissions = county_emissions,
  .sector = "Nature",
  .plotly_source = "fig-nature-sequestration"
)
fig_nature_sequestration
```



::: {.content-visible when-format="html"}

## About this document

This is a Quarto book. Code, data, and documentation are all stored in the same place. We primarily use R. 

- To navigate from chapter to chapter, click on the chapter name in the left sidebar or click the arrow button at the end of the page.
- Citations can be previewed by hovering your mouse over the citation.
- Links to R scripts are available throughout the document. Click on the link to open the relevant R script and peruse the code behind this inventory.
- All plots are interactive. Hover your mouse over any bar or dot, and detailed information will appear. If you want to take a static screenshot of a plot, hover your mouse over the plot and find the camera icon in the upper right tool bar.
- Sections are cross-referenced throughout the document. Click on a "Section x.xx.xx" link to navigate to the appropriate section
- All headings, tables, and figures are permalinked, meaning that you can share specific sections of the document through a URL. Hover your mouse over a heading and click on the link icon. Then, copy the URL in your browser and share with colleagues. 

::: 

## Acknowledgements

This document is the result of tremendous work across the Metropolitan Council. Individuals are noted by their name, title, contribution, and division. 

:::: {.columns}

::: {.column width="50%"}
#### Primary authors {.unnumbered}
 - Liz Roten, Senior Data Scientist, Transportation (MTS)  
 - Sam Limerick, Senior Data Scientist, Electricity and natural gas (CD)  
 - Peter Wilfahrt, Principal Researcher, Industrial, Agricultural, Wastewater,  (CD)   
 - Kenneth Smith, Principal Researcher, LIDAC, natural systems, Wastewater (CD)  
 - Zoey Yandell, Intern, Solid waste (CD)  
:::

::: {.column width="50%"}
#### Contributors {.unnumbered}
 - Laine McNamara, Business Systems Analyst III, editing (CD)  
:::

::::

```{r echo=FALSE}
caption_index <- readRDS(file.path(here::here(), "caption_index.RDS"))
caption_index <- as.character(as.numeric(caption_index) + 1) %>% stringr::str_pad(width = 2, side = "left", pad = "0")
saveCap(paste0("cap-", caption_index))
saveRDS(caption_index, file.path(here::here(), "caption_index.RDS"))
```

{{< pagebreak >}}

