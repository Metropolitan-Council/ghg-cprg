# Industrial methods and data sources
```{r include=FALSE}
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_plotting_helpers.R"))

hookaddcap()

county_emissions <- readRDS(file.path(here::here(), "_meta/data/cprg_county_emissions.RDS"))
flight_emissions <- readRDS(file.path(here::here(), "_industrial/data/flight_industrial_point_sources_ctu.RDS"))
nei_emissions <- readRDS(file.path(here::here(), "_industrial/data/nei_county_industrial_emissions.RDS"))
subpart_c_emissions <- readRDS(file.path(here::here(), "_industrial/data/fuel_combustion_emissions.RDS"))
nrel_emissions <- county_emissions %>% 
  filter(category == "Industrial energy" & source == "Natural gas")


```

##Summary
Industrial emissions are derived from two EPA sources: the Greenhouse Gas Reporting Program (GHGRP; via the Facility Level Information on GHG Tool) and the National Emissions Inventory (NEI). Both datasets have strengths and limitations which complement one another. The GHGRP has facility source data dating back to 2010, but only facilities with 25,000+ metric tons of annual CO2e emissions are required to report to this program. The NEI aggregate county data includes smaller facilities, but only has GHG emission estimates for 2017 and 2020 and lacks the source level specificity. Additional data resources to explore in the future for industrial emissions are the MPCA's (MN Pollution Control Agency) greenhouse gas emission estimates (also limited to larger emitters) and the federal US Energy Information Administration datasets.

## Double counting
A key concern for industrial emissions is avoiding double counting, particularly natural gas combustion, electricity generation, and waste management. Our energy analysis uses a demand side approach to allocate electricity usage and natural gas combustion to residential, commercial, and industrial sectors. For electricity, this means avoiding industrial emissions that arise from electricty generation (note GHGRP and NEI already avoid counting electricity consumption at industrial facilities in their analyses). Natural gas consumption requires greater care, as combustion for industrial units (e.g. boilers) may be one of or some combination of natural gas, petroleum products, coal, or other fuel sources. Our waste sector accounts for municipal waste emissions, though it does not inventory industrial waste processing.

## Electricity generation
Electricity generation is indicated as industrial subpart "D", and can be omitted from GHGRP data easily. Note that power plants also have some fuel combustion that are not directly for electricity generation and it is currently unclear if that is accounted for in our egrid analysis. However, in NEI data, powerplants are grouped under NEC (Not Elesewhere Classified), which includes non-powerpoint sources, requiring care to avoid double-counting (e.g. subtracting away GHGRP power plant data)

## Natural gas
Detailed data can be found in the GHGRP, particularly for fuel combustion. That allows us to subtract away natural gas combustion emissions from industrial combustion, to avoid potential double counting of natural gas utility data. Note that further inquiry is required to ensure that industrial natural gas is provisioned by the utilities. An additional subpart that requires investigation is "Y" which includes flaring data, which is often flaring of natural gas.

## Waste
We are omitting in-bound municipal waste facilities from our industrial analysis to avoid double counting with our waste emissions analyses (based on county waste volume in Minnesota).


# Data source comparisons

Currently, GHGRP data can be reliably used to avoid double-counting by avoiding emissions from Natural Gas. We can compare how subpart C (Industrial combustion) analyses compares to facilities with only subpart C FLIGHT aggregates.

```{r fig-cropland-area-emissions}
#| fig-cap: "A scatter plot"
#| out-width: "95%"


cropland_2021 <- county_agriculture %>% 
  filter(year == 2021) %>% 
  left_join(., county_emissions %>% 
              filter(sector == 'Agriculture',
                     year == 2021) %>% 
              group_by(geog_name, category) %>% 
              summarize(ag_emissions = sum(emissions_metric_tons_co2e)),
            by = c("county" = "geog_name"))


fig_cropland_area_emissions <- plot_ly(
  type = "scatter",
  mode = "markers",
  source = "fig-cropland-area-emissions",
  data = cropland_2021,
  y = ~ag_emissions,
  x = ~area,
  color = ~category,  # Map colors by category
  colors = unlist(category_colors),  # Convert list to vector of colors
  hovertemplate = ~ paste0(
    county, " County", "<br>",
    "Area: ", scales::comma(area), " square kilometers", "<br>",
    "Emissions: ", round(ag_emissions, digits = 2), " metric tons CO<sub>2</sub>e", "<br>",
    "<extra></extra>"
  ),
  marker = list(
    size = 18,
    line = list(
      color = "lightgray",
      width = 2
    )
  )
)

# Separate linear trend lines for each category
for(cat in levels(cropland_2021$category)) {
  cat_data <- cropland_2021 %>%
    filter(category == cat, !is.na(area), !is.na(ag_emissions))  # Filter out NA values

  # Only fit model if there's enough data
  if(nrow(cat_data) > 1) {
    # Fit the linear model
    model <- lm(ag_emissions ~ area, data = cat_data)
    
    # Create a sequence of area values to plot the line
    area_seq <- seq(min(cat_data$area), max(cat_data$area), length.out = 100)
    
    # Predict ag_emissions for the sequence of area values
    emissions_pred <- predict(model, newdata = data.frame(area = area_seq))
    
    # Add the line of best fit
    fig_cropland_area_emissions <- fig_cropland_area_emissions %>%
      add_trace(
        x = area_seq,
        y = emissions_pred,
        type = "scatter",
        mode = "lines",  # Ensure mode is 'lines' for the trend line
        line = list(
          color = category_colors[[cat]],  # Use the same color as the points
          dash = 'solid',
          width = 2
        ),
        showlegend = FALSE,  # Hide trend line from legend
        inherit = FALSE  # Prevent inheritance of other properties like hovertemplate
      )
  }
}

# Final layout and titles
fig_cropland_area_emissions <- fig_cropland_area_emissions %>%
  layout(
    title = list(
      text = "Area of county cropland and county agricultural emissions"
    ),
    xaxis = list(
      title = "Agricultural area km<sup>2</sup>"
    ),
    yaxis = list(
      title = "Metric tons CO<sub>2</sub>e"
    ),
    barmode = "stack",
    legend = list(
      traceorder = "reversed"
    )
  )

fig_cropland_area_emissions

```

As expected, we see that livestock and crop emissions increases with area devoted to agriculture. There is potentially a non-linear relationship with livestock, with smaller agricultural areas less likely to have large livestock populations, making the fit more tenuous for these counties.

### USDA cattle census vs annual surveys

Most USDA data is available from a five year census; we interpolate 

```{r fig-cattle-comparison}
#| fig-cap: "A scatter plot"
#| out-width: "95%"

cattle_survey <- readRDS(file.path(here::here(), "_agriculture/data/usda_cattle_survey.RDS")) %>% 
  mutate(county_name = if_else(county_name == "ST CROIX", 
                               "St. Croix", 
                               str_to_sentence(county_name)))
cattle_census <- readRDS(file.path(here::here(), "_agriculture/data/usda_census_data.RDS")) %>% 
  # calves were previous split to those in and out of feedlots
  mutate(livestock_type = if_else(livestock_type == "Feedlot Cattle", 
                                  "Calves", 
                                  livestock_type)) %>% 
  group_by(year, county_name, data_type, livestock_type) %>% 
  summarize(head_count = sum(head_count))
# Merging cattle_survey and cattle_census on the common columns
cattle_merged <- cattle_survey %>%
  left_join(cattle_census, by = c("year", "county_name", "livestock_type"), suffix = c("_survey", "_census"))

min_val <- min(c(cattle_merged$head_count_survey, cattle_merged$head_count_census), na.rm = TRUE)
max_val <- max(c(cattle_merged$head_count_survey, cattle_merged$head_count_census), na.rm = TRUE)


# Create the base plot
cattle_comparison <- plot_ly(
  type = "scatter",
  mode = "markers",
  source = "fig-cropland-area-emissions",
  data = cattle_merged
) %>%
  add_trace(
    x = ~head_count_survey, 
    y = ~head_count_census, 
    color = ~livestock_type,  # Color by livestock_type
    symbol = ~data_type,      # Change symbol based on data_type
    symbols = c('census' = 'circle', 'interpolated' = 'triangle-up'),  # Custom symbols for data_type
    marker = list(size = 10),
      hovertemplate = ~ paste0(
    county_name, " County", "<br>",
    "Census head count: ", scales::comma(head_count_census),"<br>",
    "Survey head count: ", scales::comma(head_count_survey),"<br>",
    "<extra></extra>"
  )
  ) %>%
  layout(
    title = "Comparison of Livestock Estimates: Survey vs Census",
    xaxis = list(title = "Survey Head Count"),
    yaxis = list(title = "Census Head Count"),
    legend = list(title = list(text = "Livestock Type and Data Type"))
  ) %>%
  add_trace(
    x = c(min_val, max_val), 
    y = c(min_val, max_val), 
    mode = 'lines',
    line = list(dash = 'dash', color = 'black', width = 2),
    showlegend = FALSE, 
    name = "1:1 Line"
  ) %>%
  add_trace(
    data = cattle_merged %>% filter(livestock_type == "Beef Cows"),
    x = ~head_count_survey, 
    y = ~head_count_census, 
    color = ~livestock_type,  # Color by livestock_type
    symbol = ~data_type,      # Change symbol based on data_type
    symbols = c('census' = 'circle', 'interpolated' = 'triangle-up'),
    marker = list(size = 10),
    name = "Beef Cows"
  )

cattle_comparison

```

Estimates from the census and surveys are reasonably close for dairy cows and beef cows, the former which are the biggest emitters. For calves, there is increasing disagreement between the survey and census at large head counts, with the census typically estimating lower head counts for both interpolated and actual census years. We will continue using the census head count data as it's error is likely less and it contains non-cattle animal counts.

### Scaling to CTUs

The ICLEI U.S. Community Protocol recommends, in the absence of CTU level livestock or crop production data, downscaling from county data using the ratio of agricultural land in the community to agricultural land in the county. We followed this approach for downscaling county level emissions using NLCD land cover data to find the ratio of CTU agricultural land to county agricultural land. Future work may seek to downscale livestock counts and crop production directly, to allow more direct reduction measure estimations for various agricultural components (e.g. changes to cattle feed additives that may reduce enteric fermentation).
---
