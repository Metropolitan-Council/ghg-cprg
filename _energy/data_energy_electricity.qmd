# Electricity data sources

```{r  include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.pos = "H",
  out.width = "100%",
  dpi = 300
)


knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r, include=FALSE}
source(file.path(here::here(), "R/_quarto_helpers.R"))
source(file.path(here::here(), "R/_load_pkgs.R"))
source(file.path(here::here(), "R/_leaflet_helpers.R"))
library(readr)
library(stringr) # add both to renv

# MN
MN_inScopeUtilities <- read_rds(here(
  "_energy", "data", "MN_electricity_inScope_utilityCountyPairs.RDS"
))
MN_allUtilities <- read_rds(here(
  "_energy", "data", "MN_elecUtils.RDS"
))

# WI
WI_inScopeUtilities <- read_rds(here(
  "_energy", "data", "WI_electricity_inScope_utilityCountyPairs.RDS"
))

WI_elecUtils_allTypes <- read_rds(here(
  "_energy", "data", "WI_elecUtils_allTypes.RDS"
))

WI_inScope_elecUtils_fullServTerr <- read_rds(here(
  "_energy", "data", "WI_inScope_elecUtils_fullServTerr.RDS"
))

hookaddcap()
```

## Utility Service Area Maps

To identify the utilities operating within our 11-county study area, we utilized data sets published by state sources. The outcome of our data collection, yielding a list of distinct utilities for which activity data should be collected, resides within distinct_electricity_util_WI.RDS (7 utilities, with four co-op utilities, three municipality utilities, and one investor-owned utility) and distinct_electricity_util_type_MN.RDS (18 utilities, with eight co-op utilities, nine municipality utilities, and one investor-owned utility)

### Minnesota

The Minnesota Public Utilities Commission publishes and maintains a map of electric utility service areas [@minnesotaitgeospatialinformationofficeElectricUtilityService2023]. Though this dataset is statewide(see fig. X), it is clipped to only include utility service areas within the nine Minnesota counties included in the study area of this inventory (see fig. Y -- note that utilities operating across county lines have a polygon covering the extent of their service territory within each and every county they operate within).

```{r minnesota-elec-servTerrs}
# Create a color palette
utilities <- unique(MN_allUtilities$mpuc_name)
color_palette <- colorFactor(palette = "viridis", domain = utilities)

# bounding box for Minnesota
bound_box <- list(
  lng1 = -97, # Southwest longitude (closer in)
  lat1 =  43.5, # Southwest latitude (closer in)
  lng2 = -89.5, # Northeast longitude (closer in)
  lat2 =  49 # Northeast latitude (closer in)
)

MN_elec_servTerrs <- council_leaflet() %>%
  addPolygons(
    data = MN_allUtilities %>% sf::st_transform(4326),
    fill = TRUE,
    fillColor = ~ color_palette(mpuc_name), # Use the color mapping
    stroke = TRUE,
    color = "gray",
    weight = 2,
    popup = MN_allUtilities$mpuc_name
  ) %>%
  fitBounds(
    lng1 = bound_box[[1]],
    lng2 = bound_box[[3]],
    lat1 = bound_box[[2]],
    lat2 = bound_box[[4]]
  )

MN_elec_servTerrs
```

```{r MN-elec-inScope-servTerrs}
# Create a color palette
inScopeUtilities <- unique(MN_inScopeUtilities$utility_name)
color_palette <- colorFactor(palette = "viridis", domain = inScopeUtilities)

# bounding box for MN study area counties
MN_bound_box <- list(
  lng1 = -94.5, # Southwest longitude (further zoomed out)
  lat1 =  44.7, # Southwest latitude (further zoomed out)
  lng2 = -92, # Northeast longitude (further zoomed out)
  lat2 =  45.5 # Northeast latitude (further zoomed out)
)

# Test basic functionality of the custom function
MN_elec_inScope_servTerrs <- council_leaflet() %>%
  addPolygons(
    data = MN_inScopeUtilities %>% sf::st_transform(4326),
    fill = TRUE,
    fillColor = ~ color_palette(utility_name), # Use the color mapping
    stroke = TRUE,
    color = "gray",
    weight = 2,
    popup = paste0(
      MN_inScopeUtilities$utility_name,
      ", ",
      MN_inScopeUtilities$county_name,
      " County"
    )
  ) %>%
  fitBounds(
    lng1 = MN_bound_box[[1]],
    lng2 = MN_bound_box[[3]],
    lat1 = MN_bound_box[[2]],
    lat2 = MN_bound_box[[4]]
  )

MN_elec_inScope_servTerrs
```

### Wisconsin

The Public Services Commission of Wisconsin publishes and maintains maps of service territories for electric utilities operating within the state. This data set relies upon, and is accurate to, "the extent that various sources \[utilities\] supplied accurate data." [@wisconsinpublicservicecommissionElectricServiceTerritories2024] This dataset spans the whole state of Wisconsin (see fig, X), and both clipped to the two Wisconsin counties included in the study area of this inventory (see fig. Y). However, because Wisconsin utilities do not report energy deliveries to the county level, we also generate a file with the entire service area of utilities that operate within Pierce and St. Croix County (see fig. Z), so that we can calculate population served by these utilities both within and without of our study area, as an input to estimated/modeled number of customer accounts and total energy deliveries to Pierce and St. Croix County.

```{r wisconsin-elec-servTerrs}
utilities <- unique(WI_elecUtils_allTypes$utility_name)
color_palette <- colorFactor(palette = "viridis", domain = utilities)


# bounding box for Wisconsin
bound_box <- list(
  lng1 = -92.888, # Southwest longitude
  lat1 =  42.491, # Southwest latitude
  lng2 = -86.805, # Northeast longitude
  lat2 =  47.080 # Northeast latitude
)

WI_elec_servTerrs <- council_leaflet() %>%
  addPolygons(
    data = WI_elecUtils_allTypes %>% sf::st_transform(4326),
    fill = TRUE,
    fillColor = ~ color_palette(utility_name),
    stroke = TRUE,
    color = "gray",
    weight = 2,
    popup = WI_elecUtils_allTypes$utility_name
    # Temporarily comment out group for debugging
  ) %>%
  fitBounds(
    lng1 = bound_box[[1]],
    lng2 = bound_box[[3]],
    lat1 = bound_box[[2]],
    lat2 = bound_box[[4]]
  )

WI_elec_servTerrs
```

inscope

```{r wisconsin-elec-inScope-servTerrs}
# Create a color palette
inScopeUtilities <- unique(WI_inScopeUtilities$utility_name)
color_palette <- colorFactor(palette = "viridis", domain = inScopeUtilities)


WI_bound_box <- list(
  lng1 = -92.9, # Southwest longitude
  lat1 =  44.5, # Southwest latitude
  lng2 = -92.0, # Northeast longitude
  lat2 =  45.23 # Northeast latitude
)


WI_elec_inScope_servTerrs <- council_leaflet() %>%
  addPolygons(
    data = WI_inScopeUtilities %>% sf::st_transform(4326),
    fill = TRUE,
    fillColor = ~ color_palette(utility_name),
    stroke = TRUE,
    color = "gray",
    weight = 2,
    popup = paste0(
      WI_inScopeUtilities$utility_name,
      ", ",
      WI_inScopeUtilities$county_name,
      " County"
    )
  ) %>%
  fitBounds(
    lng1 = WI_bound_box[[1]],
    lng2 = WI_bound_box[[3]],
    lat1 = WI_bound_box[[2]],
    lat2 = WI_bound_box[[4]]
  )

WI_elec_inScope_servTerrs
```

InScope whole territory

```{r wisconsin-elec-inScope-wholeServTerrs}
# Create a color palette
inScopeUtilities <- unique(WI_inScope_elecUtils_fullServTerr$utility_name)
color_palette <- colorFactor(palette = "viridis", domain = inScopeUtilities)


# bounding box for Wisconsin
WI_bound_box <- list(
  lng1 = -92.888, # Southwest longitude
  lat1 =  42.491, # Southwest latitude
  lng2 = -86.805, # Northeast longitude
  lat2 =  47.080 # Northeast latitude
)


WI_elec_inScope_wholeServTerrs <- council_leaflet() %>%
  addPolygons(
    data = WI_inScope_elecUtils_fullServTerr %>% sf::st_transform(4326),
    fill = TRUE,
    fillColor = ~ color_palette(utility_name),
    stroke = TRUE,
    color = "gray",
    weight = 2,
    popup = paste0(
      WI_inScope_elecUtils_fullServTerr$utility_name,
      ", ",
      WI_inScope_elecUtils_fullServTerr$county_name,
      " County"
    )
  ) %>%
  fitBounds(
    lng1 = WI_bound_box[[1]],
    lng2 = WI_bound_box[[3]],
    lat1 = WI_bound_box[[2]],
    lat2 = WI_bound_box[[4]]
  )

WI_elec_inScope_wholeServTerrs
```

## Utility Activity Data

### Minnesota

Under Minnesota Administrative Rules Chapter 7610 [@minnesotadepartmentofcommerceCHAPTER7610ENERGY], utilities are required to file an annual data report that supports the identification of "emerging energy trends based on supply and demand, conservation and public health and safety factors, and to determine the level of statewide and service area needs." [@minnesotadepartmentofcommerceAnnualReportingForms2022] This includes a report of county-level energy deliveries (reported in thousand cubic feet, commonly written as mcf). Because the information is structured in this manner, natural gas emissions at the county-level can be estimated as a direct function of energy deliveries to counties reported by utilities, which isn't the case in Wisconsin (some modeling and estimation is required in WI).

For electric... great river

#bar graph with utility county data

#some data exists for MN customer counts... could be worthwile to calculate account level average for comparison to WI

### Wisconsin

Under Wis. Stat. ยง 196.07, investor- and municipally owned electric utilities operating within the state of Wisconsin must submit annual reports to the State which include an array of information related to utility finance and operations, including key figures leveraged in our data collection, such as total energy deliveries made (in units of *kWh*) and total number of customer accounts within each county [@wisconsinstatelegislatureChapter186Regulation].

Of the seven in-scope electric utilities, only three (the investor- and municipally-owned utilities) were required to make these reports to the State in 2021 (four of the in-scope electric utilities are cooperative utilities); state data was leveraged in this case. For the four utilities (all cooperative utilities) not making these reports, we relied upon the detailed data files provided by the EIA, recording the responses of utilities to the Annual Electric Power Energy Report (Form EIA-861). Two utilities (Dunn Energy Cooperative and Polk-Burnett Electric Cooperative) filled the long version of the form, and two (St. Croix Electric Cooperative and Pierce-Pepin Electric Cooperative Services) filled the short form. For our purposes, both the long and short form provided suitable activity information (total energy delivered, total customers) to allocate energy deliveries to counties in concert with Census population data, in the process outlined below.

Because Wisconsin utilities do not report energy deliveries at the county level, it was necessary to estimate energy deliveries by a given utility *i* within a particular county *j.* For those three utilities who reported county-level customer counts and total customer counts to the state, we estimated mWh delivered by utility *i* in county *j* by multiplying their total statewide energy deliveries (as reported to the relevant state authorities) by the proportion of their customers residing in each of our two study area counties.

$$mWhDelivered_iCounty_j =  (mWhEnergyDeliveries_i \times {ProportionOfTotalUtilityCustomers_j}) $$

To calculate the estimated energy delivered by utility *i* in county *j* for the four utilities that did not report county-level customer counts, we used population figures to allocate energy deliveries to counties. We took the actual total energy delivered by utility *i* (as reported to the relevant federal authorities) and multiplied this by the proportion of population within each utility's entire service area residing within county *j* at the 2020 decennial Census.

$$mWhDelivered_iCounty_j =  (mWhDelivered_i \times {ProportionOfTotalUtilityPopulation_j}) $$

The factor *ProportionOfTotalUtilityPopulation*~j~ was calculated by first spatially joining the two.... (where each polygon represents a given utility's service terrirory within a given county) to a spatial file containing total population for Census blocks using the block centroids, and then summing This step was completed in ArcGIS Pro and brought back to R due to memory constraints in RStudio on the relevant Met Council staffer's work machine.

*Inquiries have been made...*

Because all four "in-scope" natural gas utilities in Wisconsin are investor-owned, we were able to estimate county-wide emissions from natural gas in 2021 by first calculating the proportion of each utility customer's residing within Pierce and St. Croix counties, and allocating that proportion of the utility's total reported energy delivery to each county. This approach represents a divergence from our Minnesota process, which involves aggregating county-level numbers directly reported by utilities, and implicitly assumes that customer accounts across counties within the operations of a given utility have the same average per-account demand for energy, when in actuality this is likely impacted by land-use mix and relative magnitude/scale of residential and commercial/industrial utility accounts within a given county (citation needed?)

#histogram or other visualization of customer

For electric... justifying modeling approach (reference to mean, use of a weighted average of per-account numbers for all utilities where we have actual and estimated per-account figures. All an estimation.

For electric.. more detail on how population in service territories was used to 1) estimate customer/account counts, 2) allocate total utility numbers based on estimated accounts within the in-scope area, and 3) use estimated per-customer energy deliveries, alongside population figures and total customer counts within and without our study area for the two utilities that didn't energy activity to the state or federal government, to model energy delivery --\> customers/cus

Data source description, type

-   Quality rank (See @tbl-quality-rank)
-   How, when, and why was the data collected?
-   If this is a modeled dataset, what is the sample?
-   What is the raw unit of measurement?
-   How was this data accessed? Include any relevant links/citations, code, or downloads.
-   What data cleaning or wrangling was completed? How did you test these processes and outputs?
-   What is the geographic and temporal scope? Did you complete any aggregation?
-   What version is the data? Were there other versions available? If so, why did you choose this version?
-   What assumptions are made when we use this dataset?
-   Which subject matter expert (SME) reviewed this data?
-   Describe testing used to verify data

Be sure to add a citation of this dataset to the Zotero shared library.

##### Data characteristics

-   Were there any missing data? How did you handle missing data?
-   Plots, tables, and description of data distribution
-   Variance, Z-Score, quantiles
-   Facet views by categorical variables

##### Limitations

-   Usually only samples county and state roads, primary arterials
-   Not every site is sampled every year

Additionally, aggregating

#### Vehicle distribution by weight

Introduction text Data source description, type

-   Quality rank (See @tbl-quality-rank)
-   How, when, and why was the data collected?
-   If this is a modeled dataset, what is the sample?
-   What is the raw unit of measurement?
-   How was this data accessed? Include any relevant links/citations, code, or downloads.
-   What data cleaning or wrangling was completed? How did you test these processes and outputs?
-   What is the geographic and temporal scope? Did you complete any aggregation?
-   What version is the data? Were there other versions available? If so, why did you choose this version?
-   What assumptions are made when we use this dataset?
-   Which subject matter expert (SME) reviewed this data?
-   Describe testing used to verify data

Be sure to add a citation of this dataset to the Zotero shared library.

##### Data characteristics

-   Were there any missing data? How did you handle missing data?
-   Plots, tables, and description of data distribution
-   Variance, Z-Score, quantiles
-   Facet views by categorical variables

##### Limitations

### Data dictionaries

```{r echo=FALSE}
saveCap("energy-data")
```
